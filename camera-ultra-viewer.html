<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì∫ ‰ΩéÈÅÖÂª∂„Ç´„É°„É©Ë¶ñËÅ¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #000, #1a1a1a);
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        /* Èö†„Åó„Éú„Çø„É≥ÔºàÂ∑¶‰∏ä5Âõû„Çø„ÉÉ„ÉóÔºâ */
        .hidden-back-btn {
            position: fixed;
            top: 0;
            left: 0;
            width: 80px;
            height: 80px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 1000;
            opacity: 0;
        }
        
        /* „É°„Ç§„É≥Êò†ÂÉè„Ç≥„É≥„ÉÜ„Éä */
        .video-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #000, #1a1a1a);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Êò†ÂÉèË¶ÅÁ¥† */
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #000;
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* Êé•Á∂ö„Éë„Éç„É´ */
        .connection-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 100;
            max-width: 90%;
            width: 450px;
            border: 2px solid rgba(255, 107, 107, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .connection-panel.hidden {
            display: none;
        }
        
        .panel-title {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status.scanning {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196F3;
        }
        
        .status.connected {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }
        
        /* „Éá„Éê„Ç§„Çπ‰∏ÄË¶ß */
        .device-list {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .device-list-title {
            color: #FF6B6B;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .device-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .device-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 107, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .device-item:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.1));
            border-color: #FF6B6B;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        
        .device-item:hover::before {
            left: 100%;
        }
        
        .device-item.connecting {
            border-color: #ff9800;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 152, 0, 0.1));
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .device-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #FF6B6B;
        }
        
        .device-info {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }
        
        .device-quality {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .no-devices {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-refresh { 
            background: linear-gradient(135deg, #4CAF50, #81C784);
            color: white;
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f44336, #EF5350);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-align: center;
            z-index: 50;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .loading.hidden {
            display: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 107, 107, 0.3);
            border-top: 4px solid #FF6B6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Áµ±Ë®àÊÉÖÂ†± */
        .stats-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            z-index: 200;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .stats-overlay.hidden {
            display: none;
        }
        
        /* „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ */
        .error-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 80%;
            text-align: center;
        }
        
        .error-message.show {
            opacity: 1;
        }
        
        .instructions {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 20px;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }
        
        .instructions strong {
            color: #FF6B6B;
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
        @media (max-width: 768px) {
            .connection-panel {
                width: 95%;
                padding: 20px;
            }
            
            .panel-title {
                font-size: 22px;
            }
            
            .device-name {
                font-size: 18px;
            }
            
            .stats-overlay {
                top: 10px;
                right: 10px;
                font-size: 10px;
            }
        }
        
        /* Êé•Á∂öÊàêÂäüÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà */
        .success-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 500;
            opacity: 0;
            animation: successPulse 1s ease-out;
        }
        
        @keyframes successPulse {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Èö†„Åó„Éú„Çø„É≥ÔºàÂ∑¶‰∏ä5Âõû„Çø„ÉÉ„Éó„Åß„Éõ„Éº„É†Ôºâ -->
    <button class="hidden-back-btn" id="hiddenBackBtn"></button>
    
    <!-- „É°„Ç§„É≥Êò†ÂÉèË°®Á§∫ -->
    <div class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
        
        <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>üì° Ë∂Ö‰ΩéÈÅÖÂª∂Êò†ÂÉè„ÇíÂèó‰ø°‰∏≠...</div>
            <div style="margin-top: 10px; font-size: 16px; color: rgba(255, 255, 255, 0.7);">
                „Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ
            </div>
        </div>
        
        <!-- Êé•Á∂ö„Éë„Éç„É´ -->
        <div class="connection-panel" id="connectionPanel">
            <div class="panel-title">üöÄ Ë∂Ö‰ΩéÈÅÖÂª∂„Ç´„É°„É©Ë¶ñËÅ¥</div>
            
            <div class="status" id="status">
                üì° ÈÖç‰ø°‰∏≠„Éá„Éê„Ç§„Çπ„ÇíÊ§úÁ¥¢‰∏≠...
            </div>
            
            <div class="device-list" id="deviceList">
                <div class="device-list-title">üì± ÈÖç‰ø°‰∏≠„ÅÆ„Éá„Éê„Ç§„Çπ</div>
                <div class="no-devices" id="noDevicesMessage">
                    <div>üîç Ê§úÁ¥¢‰∏≠...</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        „Éá„Éê„Ç§„ÇπÂÅ¥„ÅßÈÖç‰ø°„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                </div>
            </div>
            
            <button class="btn-refresh" id="refreshBtn">üîÑ ÂÜçÊ§úÁ¥¢</button>
            <button class="btn-danger" id="disconnectBtn">‚ùå ÂàáÊñ≠</button>
            
            <div class="instructions">
                <strong>üìã Êé•Á∂öÊñπÊ≥ïÔºö</strong><br>
                1. ÈÖç‰ø°‰∏≠„ÅÆ„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû<br>
                2. Ëá™ÂãïÁöÑ„Å´Ë∂Ö‰ΩéÈÅÖÂª∂Êé•Á∂ö„Åï„Çå„Åæ„Åô<br>
                3. Êò†ÂÉè„ÅåÂÖ®ÁîªÈù¢Ë°®Á§∫„Åï„Çå„Åæ„Åô<br>
                4. Â∑¶‰∏ä„Çí5Âõû„Çø„ÉÉ„Éó„Åß„Éõ„Éº„É†ÁîªÈù¢
            </div>
        </div>
        
        <!-- Áµ±Ë®àÊÉÖÂ†± -->
        <div class="stats-overlay hidden" id="statsOverlay">
            <div>üìä Âèó‰ø°Áµ±Ë®à</div>
            <div>Âèó‰ø°: <span id="receiveBitrate">--- kbps</span></div>
            <div>FPS: <span id="receiveFps">--- fps</span></div>
            <div>ÈÅÖÂª∂: <span id="latency">--- ms</span></div>
            <div>Ëß£ÂÉèÂ∫¶: <span id="resolution">---</span></div>
        </div>
    </div>
    
    <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        let peer = null;
        let connection = null;
        let call = null;
        let isConnected = false;
        let devices = {};
        let statsInterval = null;
        let scanTimer = null;
        
        // DOMË¶ÅÁ¥†
        const connectionPanel = document.getElementById('connectionPanel');
        const status = document.getElementById('status');
        const deviceList = document.getElementById('deviceList');
        const noDevicesMessage = document.getElementById('noDevicesMessage');
        const remoteVideo = document.getElementById('remoteVideo');
        const loading = document.getElementById('loading');
        const statsOverlay = document.getElementById('statsOverlay');
        const errorMessage = document.getElementById('errorMessage');
        
        const refreshBtn = document.getElementById('refreshBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        // „É≠„Ç∞Ê©üËÉΩ
        function log(message) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
        
        // Èö†„Åó„Éú„Çø„É≥ÔºàÂ∑¶‰∏ä5Âõû„Çø„ÉÉ„ÉóÔºâ
        let tapCount = 0;
        let tapTimer = null;
        document.getElementById('hiddenBackBtn').addEventListener('click', function() {
            tapCount++;
            
            if (tapTimer) {
                clearTimeout(tapTimer);
            }
            
            if (tapCount >= 5) {
                goHome();
                return;
            }
            
            // 2Áßí‰ª•ÂÜÖ„Å´„Çø„ÉÉ„Éó„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„É™„Çª„ÉÉ„Éà
            tapTimer = setTimeout(() => {
                tapCount = 0;
            }, 2000);
        });
        
        // „Éõ„Éº„É†„Å´Êàª„Çã
        function goHome() {
            disconnect();
            window.location.href = 'index.html';
        }
        
        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function updateStatus(message, className = '') {
            status.textContent = message;
            status.className = className ? `status ${className}` : 'status';
        }
        
        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 6000);
        }
        
        // ÊàêÂäü„Ç®„Éï„Çß„ÇØ„Éà
        function showSuccessEffect() {
            const effect = document.createElement('div');
            effect.className = 'success-effect';
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1000);
        }
        
        // ÈÖç‰ø°‰∏≠„Éá„Éê„Ç§„ÇπÊ§úÁ¥¢
        function scanForDevices() {
            log('ÈÖç‰ø°‰∏≠„Éá„Éê„Ç§„ÇπÊ§úÁ¥¢ÈñãÂßã');
            
            if (typeof firebase !== 'undefined' && firebase.database) {
                const ref = firebase.database().ref('ultra-broadcasts');
                
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    devices = {};
                    
                    if (data) {
                        const now = Date.now();
                        // 30Áßí‰ª•ÂÜÖ„ÅÆ„Éè„Éº„Éà„Éì„Éº„Éà„ÅÆ„ÅøÊúâÂäπ„Å®„Åô„Çã
                        Object.keys(data).forEach(key => {
                            const device = data[key];
                            if (device.active && device.timestamp && (now - device.timestamp) < 30000) {
                                devices[key] = device;
                            }
                        });
                    }
                    
                    updateDeviceList();
                });
            } else {
                log('FirebaseÁÑ°Âäπ - ‰ª£Êõø„Çπ„Ç≠„É£„É≥‰ΩøÁî®');
                updateStatus('‚ö†Ô∏è FirebaseÁÑ°Âäπ', 'error');
                showError('FirebaseÊé•Á∂ö„Ç®„É©„Éº - ÊâãÂãïÊ§úÁ¥¢„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
        }
        
        // „Éá„Éê„Ç§„Çπ‰∏ÄË¶ßÊõ¥Êñ∞
        function updateDeviceList() {
            const deviceCount = Object.keys(devices).length;
            log(`Ê§úÂá∫„Éá„Éê„Ç§„ÇπÊï∞: ${deviceCount}`);
            
            if (deviceCount === 0) {
                noDevicesMessage.innerHTML = `
                    <div>üì± ÈÖç‰ø°‰∏≠„ÅÆ„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        „Éá„Éê„Ç§„ÇπÂÅ¥„ÅßÈÖç‰ø°„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                `;
                updateStatus('üì° ÈÖç‰ø°‰∏≠„ÅÆ„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            updateStatus(`üöÄ ${deviceCount}Âè∞„ÅÆË∂Ö‰ΩéÈÅÖÂª∂„Éá„Éê„Ç§„Çπ„ÇíÁô∫Ë¶ã`, 'connected');
            
            let html = '';
            Object.keys(devices).forEach(key => {
                const device = devices[key];
                const timeDiff = Date.now() - device.timestamp;
                const timeStr = timeDiff < 10000 ? 'ÈÖç‰ø°‰∏≠' : `${Math.floor(timeDiff / 1000)}ÁßíÂâç`;
                
                html += `
                    <div class="device-item" onclick="connectToDevice('${device.id}', '${device.name}')">
                        <div class="device-name">üöÄ ${device.name}</div>
                        <div class="device-info">
                            ÈÖç‰ø°ID: ${device.id}<br>
                            ÂìÅË≥™: ${device.quality}<br>
                            Ëß£ÂÉèÂ∫¶: ${device.resolution} @${device.fps}fps<br>
                            Êõ¥Êñ∞: ${timeStr}
                        </div>
                        <div class="device-quality">ULTRA LOW LATENCY</div>
                    </div>
                `;
            });
            
            noDevicesMessage.innerHTML = html;
        }
        
        // „Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö
        async function connectToDevice(deviceId, deviceName) {
            try {
                log(`Êé•Á∂öÈñãÂßã: ${deviceName} (${deviceId})`);
                updateStatus('üîó Ë∂Ö‰ΩéÈÅÖÂª∂Êé•Á∂ö‰∏≠...', 'scanning');
                loading.classList.remove('hidden');
                
                // Êé•Á∂ö‰∏≠„ÅÆË¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                const items = document.querySelectorAll('.device-item');
                items.forEach(item => {
                    if (item.textContent.includes(deviceName)) {
                        item.classList.add('connecting');
                    }
                });
                
                // Ë∂Ö‰ΩéÈÅÖÂª∂PeerJSÂàùÊúüÂåñ
                const viewerId = `ultra-viewer-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
                
                peer = new Peer(viewerId, {
                    debug: 1,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ],
                        iceTransportPolicy: 'all',
                        bundlePolicy: 'max-compat',
                        rtcpMuxPolicy: 'require',
                        iceCandidatePoolSize: 10,
                        // ‰ΩéÈÅÖÂª∂„Å´ÈáçË¶Å„Å™Ë®≠ÂÆö
                        sdpSemantics: 'unified-plan'
                    }
                });
                
                peer.on('open', (id) => {
                    log(`Viewer ID: ${id}`);
                    
                    // ÈÖç‰ø°ËÄÖ„Å´Êé•Á∂ö
                    connection = peer.connect(deviceId);
                    
                    connection.on('open', () => {
                        log('„Éá„Éº„ÇøÊé•Á∂öÁ¢∫Á´ã');
                        updateStatus('üì° „Éá„Éº„ÇøÊé•Á∂öÂÆå‰∫Ü', 'connected');
                        
                        // Èü≥Â£∞„ÉªÊò†ÂÉèÈÄöË©±ÈñãÂßã
                        call = peer.call(deviceId, new MediaStream());
                        
                        call.on('stream', (remoteStream) => {
                            log('Ë∂Ö‰ΩéÈÅÖÂª∂Êò†ÂÉè„Çπ„Éà„É™„Éº„É†Âèó‰ø°');
                            
                            // Ë∂Ö‰ΩéÈÅÖÂª∂Êò†ÂÉèË°®Á§∫Ë®≠ÂÆö
                            remoteVideo.srcObject = remoteStream;
                            remoteVideo.muted = true;
                            remoteVideo.autoplay = true;
                            remoteVideo.playsInline = true;
                            remoteVideo.setAttribute('playsinline', 'true');
                            
                            // GPUÂä†ÈÄü„Å®„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ
                            remoteVideo.style.transform = 'translateZ(0)';
                            remoteVideo.style.willChange = 'transform';
                            remoteVideo.style.backfaceVisibility = 'hidden';
                            
                            // ÂÖ®ÁîªÈù¢Ë°®Á§∫
                            connectionPanel.classList.add('hidden');
                            loading.classList.add('hidden');
                            statsOverlay.classList.remove('hidden');
                            isConnected = true;
                            
                            showSuccessEffect();
                            updateStatus('üî¥ Ë∂Ö‰ΩéÈÅÖÂª∂Êò†ÂÉèÂèó‰ø°‰∏≠', 'connected');
                            
                            // Áµ±Ë®àÊÉÖÂ†±ÈñãÂßã
                            startStats();
                            
                            // Êò†ÂÉèÊÉÖÂ†±Ë°®Á§∫
                            const videoTrack = remoteStream.getVideoTracks()[0];
                            if (videoTrack) {
                                const settings = videoTrack.getSettings();
                                document.getElementById('resolution').textContent = 
                                    `${settings.width}x${settings.height}`;
                            }
                        });
                        
                        call.on('close', () => {
                            log('ÈÄöË©±ÁµÇ‰∫Ü');
                            disconnect();
                        });
                        
                        call.on('error', (error) => {
                            log(`ÈÄöË©±„Ç®„É©„Éº: ${error.message}`);
                            showError('Êò†ÂÉè„ÅÆÂèó‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                            disconnect();
                        });
                        
                        // Ë∂Ö‰ΩéÈÅÖÂª∂Âèó‰ø°Ë®≠ÂÆö
                        setupUltraLowLatencyReceiver(call);
                    });
                    
                    connection.on('data', (data) => {
                        log(`Âèó‰ø°„Éá„Éº„Çø: ${JSON.stringify(data)}`);
                    });
                    
                    connection.on('close', () => {
                        log('„Éá„Éº„ÇøÊé•Á∂öÁµÇ‰∫Ü');
                        disconnect();
                    });
                    
                    connection.on('error', (error) => {
                        log(`Êé•Á∂ö„Ç®„É©„Éº: ${error.message}`);
                        showError('ÈÖç‰ø°ËÄÖ„Å∏„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        updateStatus('‚ùå Êé•Á∂öÂ§±Êïó', 'error');
                        loading.classList.add('hidden');
                        removeConnectingState();
                    });
                });
                
                peer.on('error', (error) => {
                    log(`Peer „Ç®„É©„Éº: ${error.type} - ${error.message}`);
                    let errorMsg = 'Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    
                    if (error.type === 'peer-unavailable') {
                        errorMsg = `${deviceName}„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`;
                    } else if (error.type === 'network') {
                        errorMsg = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„Åß„Åô';
                    }
                    
                    showError(errorMsg);
                    updateStatus('‚ùå Êé•Á∂ö„Ç®„É©„Éº', 'error');
                    loading.classList.add('hidden');
                    removeConnectingState();
                });
                
                // Êé•Á∂ö„Çø„Ç§„É†„Ç¢„Ç¶„Éà
                setTimeout(() => {
                    if (!isConnected && peer) {
                        showError('Êé•Á∂ö„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
                        disconnect();
                    }
                }, 20000);
                
            } catch (error) {
                log(`Êé•Á∂öÈñãÂßã„Ç®„É©„Éº: ${error.message}`);
                showError('Êé•Á∂ö„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                updateStatus('‚ùå Êé•Á∂ö„Ç®„É©„Éº', 'error');
                loading.classList.add('hidden');
                removeConnectingState();
            }
        }
        
        // Ë∂Ö‰ΩéÈÅÖÂª∂Âèó‰ø°Ë®≠ÂÆö
        async function setupUltraLowLatencyReceiver(call) {
            try {
                const pc = call.peerConnection;
                const receivers = pc.getReceivers();
                
                receivers.forEach(receiver => {
                    if (receiver.track && receiver.track.kind === 'video') {
                        log('„Éì„Éá„Ç™Âèó‰ø°ËÄÖ„ÅÆË∂Ö‰ΩéÈÅÖÂª∂Ë®≠ÂÆö');
                        
                        // „Éà„É©„É≥„Ç∑„Éº„Éê„Éº„ÅÆË®≠ÂÆö
                        const transceiver = pc.getTransceivers().find(t => t.receiver === receiver);
                        if (transceiver) {
                            transceiver.direction = 'recvonly';
                            log('Âèó‰ø°Â∞ÇÁî®„É¢„Éº„ÉâË®≠ÂÆöÂÆå‰∫Ü');
                        }
                    }
                });
                
            } catch (error) {
                log(`Ë∂Ö‰ΩéÈÅÖÂª∂Âèó‰ø°Ë®≠ÂÆö„Ç®„É©„Éº: ${error.message}`);
            }
        }
        
        // Áµ±Ë®àÊÉÖÂ†±ÈñãÂßã
        function startStats() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            
            statsInterval = setInterval(async () => {
                if (call && call.peerConnection) {
                    try {
                        const stats = await call.peerConnection.getStats();
                        
                        let receiveBitrate = 0;
                        let receiveFps = 0;
                        let rtt = 0;
                        
                        stats.forEach(report => {
                            if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                if (report.bytesReceived) {
                                    receiveBitrate = Math.round((report.bytesReceived * 8) / 1000);
                                }
                                if (report.framesPerSecond) {
                                    receiveFps = Math.round(report.framesPerSecond);
                                }
                            }
                            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                if (report.currentRoundTripTime) {
                                    rtt = Math.round(report.currentRoundTripTime * 1000);
                                }
                            }
                        });
                        
                        document.getElementById('receiveBitrate').textContent = receiveBitrate + ' kbps';
                        document.getElementById('receiveFps').textContent = receiveFps + ' fps';
                        document.getElementById('latency').textContent = rtt + ' ms';
                        
                    } catch (error) {
                        log(`Áµ±Ë®àÊÉÖÂ†±„Ç®„É©„Éº: ${error.message}`);
                    }
                }
            }, 1000);
        }
        
        // Êé•Á∂ö‰∏≠Áä∂ÊÖãÂâäÈô§
        function removeConnectingState() {
            const items = document.querySelectorAll('.device-item');
            items.forEach(item => item.classList.remove('connecting'));
        }
        
        // ÂàáÊñ≠
        function disconnect() {
            if (call) {
                call.close();
                call = null;
            }
            
            if (connection) {
                connection.close();
                connection = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject = null;
            }
            
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            isConnected = false;
            
            connectionPanel.classList.remove('hidden');
            loading.classList.add('hidden');
            statsOverlay.classList.add('hidden');
            
            removeConnectingState();
            
            updateStatus('üì° ÈÖç‰ø°‰∏≠„Éá„Éê„Ç§„Çπ„ÇíÊ§úÁ¥¢‰∏≠...', 'scanning');
            
            // ÂÜçÊ§úÁ¥¢
            scanForDevices();
        }
        
        // ÂÜçÊ§úÁ¥¢
        function refresh() {
            log('ÊâãÂãïÂÜçÊ§úÁ¥¢');
            updateStatus('üì° ÈÖç‰ø°‰∏≠„Éá„Éê„Ç§„Çπ„ÇíÊ§úÁ¥¢‰∏≠...', 'scanning');
            devices = {};
            updateDeviceList();
            scanForDevices();
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
        window.connectToDevice = connectToDevice;
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        refreshBtn.addEventListener('click', refresh);
        disconnectBtn.addEventListener('click', disconnect);
        
        // ÂÖ®ÁîªÈù¢Ë°®Á§∫ÊôÇ„ÅÆ„Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isConnected) {
                disconnect();
            }
        });
        
        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('üì° ÈÖç‰ø°‰∏≠„Éá„Éê„Ç§„Çπ„ÇíÊ§úÁ¥¢‰∏≠...', 'scanning');
            scanForDevices();
            log('Ë∂Ö‰ΩéÈÅÖÂª∂„Ç´„É°„É©Ë¶ñËÅ¥„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
        });
        
        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            disconnect();
        });
        
        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        window.addEventListener('error', (event) => {
            log(`„Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº: ${event.error}`);
            showError('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        });
    </script>
</body>
</html> 