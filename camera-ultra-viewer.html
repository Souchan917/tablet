<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“º ä½é…å»¶ã‚«ãƒ¡ãƒ©è¦–è´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #000, #1a1a1a);
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
        }
        
        /* éš ã—ãƒœã‚¿ãƒ³ï¼ˆå·¦ä¸Š5å›ã‚¿ãƒƒãƒ—ï¼‰ */
        .hidden-back-btn {
            position: fixed;
            top: 0;
            left: 0;
            width: 80px;
            height: 80px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 1000;
            opacity: 0;
        }
        
        /* ãƒ¡ã‚¤ãƒ³æ˜ åƒã‚³ãƒ³ãƒ†ãƒŠ */
        .video-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #000, #1a1a1a);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* æ˜ åƒè¦ç´  */
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #000;
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
        }
        
        /* æ¥ç¶šãƒ‘ãƒãƒ« */
        .connection-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 100;
            max-width: 90%;
            width: 450px;
            border: 2px solid rgba(255, 107, 107, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .connection-panel.hidden {
            display: none;
        }
        
        .panel-title {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status.scanning {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196F3;
        }
        
        .status.connected {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }
        
        /* ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ */
        .device-list {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .device-list-title {
            color: #FF6B6B;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .device-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .device-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 107, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .device-item:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.1));
            border-color: #FF6B6B;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        
        .device-item:hover::before {
            left: 100%;
        }
        
        .device-item.connecting {
            border-color: #ff9800;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 152, 0, 0.1));
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .device-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #FF6B6B;
        }
        
        .device-info {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }
        
        .device-quality {
            display: inline-block;
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .no-devices {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-refresh { 
            background: linear-gradient(135deg, #4CAF50, #81C784);
            color: white;
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f44336, #EF5350);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-align: center;
            z-index: 50;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .loading.hidden {
            display: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 107, 107, 0.3);
            border-top: 4px solid #FF6B6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* çµ±è¨ˆæƒ…å ± */
        .stats-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            z-index: 200;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .stats-overlay.hidden {
            display: none;
        }
        
        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 80%;
            text-align: center;
        }
        
        .error-message.show {
            opacity: 1;
        }
        
        .instructions {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 20px;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }
        
        .instructions strong {
            color: #FF6B6B;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .connection-panel {
                width: 95%;
                padding: 20px;
            }
            
            .panel-title {
                font-size: 22px;
            }
            
            .device-name {
                font-size: 18px;
            }
            
            .stats-overlay {
                top: 10px;
                right: 10px;
                font-size: 10px;
            }
        }
        
        /* æ¥ç¶šæˆåŠŸæ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .success-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 500;
            opacity: 0;
            animation: successPulse 1s ease-out;
        }
        
        @keyframes successPulse {
            0% { opacity: 0; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- éš ã—ãƒœã‚¿ãƒ³ï¼ˆå·¦ä¸Š5å›ã‚¿ãƒƒãƒ—ã§ãƒ›ãƒ¼ãƒ ï¼‰ -->
    <button class="hidden-back-btn" id="hiddenBackBtn"></button>
    
    <!-- ãƒ¡ã‚¤ãƒ³æ˜ åƒè¡¨ç¤º -->
    <div class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
        
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>ğŸ“¡ è¶…ä½é…å»¶æ˜ åƒã‚’å—ä¿¡ä¸­...</div>
            <div style="margin-top: 10px; font-size: 16px; color: rgba(255, 255, 255, 0.7);">
                ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
            </div>
        </div>
        
        <!-- æ¥ç¶šãƒ‘ãƒãƒ« -->
        <div class="connection-panel" id="connectionPanel">
            <div class="panel-title">ğŸš€ è¶…ä½é…å»¶ã‚«ãƒ¡ãƒ©è¦–è´</div>
            
            <div class="status" id="status">
                ğŸ“¡ é…ä¿¡ä¸­ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...
            </div>
            
            <div class="device-list" id="deviceList">
                <div class="device-list-title">ğŸ“± é…ä¿¡ä¸­ã®ãƒ‡ãƒã‚¤ã‚¹</div>
                <div class="no-devices" id="noDevicesMessage">
                    <div>ğŸ” æ¤œç´¢ä¸­...</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        ãƒ‡ãƒã‚¤ã‚¹å´ã§é…ä¿¡ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>
            
            <button class="btn-refresh" id="refreshBtn">ğŸ”„ å†æ¤œç´¢</button>
            <button class="btn-danger" id="disconnectBtn">âŒ åˆ‡æ–­</button>
            
            <div class="instructions">
                <strong>ğŸ“‹ æ¥ç¶šæ–¹æ³•ï¼š</strong><br>
                1. é…ä¿¡ä¸­ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ<br>
                2. è‡ªå‹•çš„ã«è¶…ä½é…å»¶æ¥ç¶šã•ã‚Œã¾ã™<br>
                3. æ˜ åƒãŒå…¨ç”»é¢è¡¨ç¤ºã•ã‚Œã¾ã™<br>
                4. å·¦ä¸Šã‚’5å›ã‚¿ãƒƒãƒ—ã§ãƒ›ãƒ¼ãƒ ç”»é¢
            </div>
        </div>
        
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-overlay hidden" id="statsOverlay">
            <div>ğŸ“Š å—ä¿¡çµ±è¨ˆ</div>
            <div>å—ä¿¡: <span id="receiveBitrate">--- kbps</span></div>
            <div>FPS: <span id="receiveFps">--- fps</span></div>
            <div>é…å»¶: <span id="latency">--- ms</span></div>
            <div>è§£åƒåº¦: <span id="resolution">---</span></div>
        </div>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        let peer = null;
        let connection = null;
        let call = null;
        let isConnected = false;
        let devices = {};
        let statsInterval = null;
        let scanTimer = null;
        
        // DOMè¦ç´ 
        const connectionPanel = document.getElementById('connectionPanel');
        const status = document.getElementById('status');
        const deviceList = document.getElementById('deviceList');
        const noDevicesMessage = document.getElementById('noDevicesMessage');
        const remoteVideo = document.getElementById('remoteVideo');
        const loading = document.getElementById('loading');
        const statsOverlay = document.getElementById('statsOverlay');
        const errorMessage = document.getElementById('errorMessage');
        
        const refreshBtn = document.getElementById('refreshBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        
        // ãƒ­ã‚°æ©Ÿèƒ½
        function log(message) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
        
        // éš ã—ãƒœã‚¿ãƒ³ï¼ˆå·¦ä¸Š5å›ã‚¿ãƒƒãƒ—ï¼‰
        let tapCount = 0;
        let tapTimer = null;
        document.getElementById('hiddenBackBtn').addEventListener('click', function() {
            tapCount++;
            
            if (tapTimer) {
                clearTimeout(tapTimer);
            }
            
            if (tapCount >= 5) {
                goHome();
                return;
            }
            
            // 2ç§’ä»¥å†…ã«ã‚¿ãƒƒãƒ—ã—ãªã‹ã£ãŸå ´åˆãƒªã‚»ãƒƒãƒˆ
            tapTimer = setTimeout(() => {
                tapCount = 0;
            }, 2000);
        });
        
        // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        function goHome() {
            disconnect();
            window.location.href = 'index.html';
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, className = '') {
            status.textContent = message;
            status.className = className ? `status ${className}` : 'status';
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 6000);
        }
        
        // æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function showSuccessEffect() {
            const effect = document.createElement('div');
            effect.className = 'success-effect';
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1000);
        }
        
        // é…ä¿¡ä¸­ãƒ‡ãƒã‚¤ã‚¹æ¤œç´¢
        function scanForDevices() {
            log('é…ä¿¡ä¸­ãƒ‡ãƒã‚¤ã‚¹æ¤œç´¢é–‹å§‹');
            
            if (typeof firebase !== 'undefined' && firebase.database) {
                const ref = firebase.database().ref('ultra-broadcasts');
                
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    devices = {};
                    
                    if (data) {
                        const now = Date.now();
                        // 30ç§’ä»¥å†…ã®ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã®ã¿æœ‰åŠ¹ã¨ã™ã‚‹
                        Object.keys(data).forEach(key => {
                            const device = data[key];
                            if (device.active && device.timestamp && (now - device.timestamp) < 30000) {
                                devices[key] = device;
                            }
                        });
                    }
                    
                    updateDeviceList();
                });
            } else {
                log('Firebaseç„¡åŠ¹ - ä»£æ›¿ã‚¹ã‚­ãƒ£ãƒ³ä½¿ç”¨');
                updateStatus('âš ï¸ Firebaseç„¡åŠ¹', 'error');
                showError('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼ - æ‰‹å‹•æ¤œç´¢ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„');
            }
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§æ›´æ–°
        function updateDeviceList() {
            const deviceCount = Object.keys(devices).length;
            log(`æ¤œå‡ºãƒ‡ãƒã‚¤ã‚¹æ•°: ${deviceCount}`);
            
            if (deviceCount === 0) {
                noDevicesMessage.innerHTML = `
                    <div>ğŸ“± é…ä¿¡ä¸­ã®ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        ãƒ‡ãƒã‚¤ã‚¹å´ã§é…ä¿¡ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                    </div>
                `;
                updateStatus('ğŸ“¡ é…ä¿¡ä¸­ã®ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            updateStatus(`ğŸš€ ${deviceCount}å°ã®è¶…ä½é…å»¶ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™ºè¦‹`, 'connected');
            
            let html = '';
            Object.keys(devices).forEach(key => {
                const device = devices[key];
                const timeDiff = Date.now() - device.timestamp;
                const timeStr = timeDiff < 10000 ? 'é…ä¿¡ä¸­' : `${Math.floor(timeDiff / 1000)}ç§’å‰`;
                
                html += `
                    <div class="device-item" onclick="connectToDevice('${device.id}', '${device.name}')">
                        <div class="device-name">ğŸš€ ${device.name}</div>
                        <div class="device-info">
                            é…ä¿¡ID: ${device.id}<br>
                            å“è³ª: ${device.quality}<br>
                            è§£åƒåº¦: ${device.resolution} @${device.fps}fps<br>
                            æ›´æ–°: ${timeStr}
                        </div>
                        <div class="device-quality">ULTRA LOW LATENCY</div>
                    </div>
                `;
            });
            
            noDevicesMessage.innerHTML = html;
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶š
        async function connectToDevice(deviceId, deviceName) {
            try {
                log(`æ¥ç¶šé–‹å§‹: ${deviceName} (${deviceId})`);
                updateStatus('ğŸ”— è¶…ä½é…å»¶æ¥ç¶šä¸­...', 'scanning');
                loading.classList.remove('hidden');
                
                // æ¥ç¶šä¸­ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const items = document.querySelectorAll('.device-item');
                items.forEach(item => {
                    if (item.textContent.includes(deviceName)) {
                        item.classList.add('connecting');
                    }
                });
                
                // è¶…ä½é…å»¶PeerJSåˆæœŸåŒ–
                const viewerId = `ultra-viewer-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;
                
                peer = new Peer(viewerId, {
                    debug: 1,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ],
                        iceTransportPolicy: 'all',
                        bundlePolicy: 'max-compat',
                        rtcpMuxPolicy: 'require',
                        iceCandidatePoolSize: 10,
                        // ä½é…å»¶ã«é‡è¦ãªè¨­å®š
                        sdpSemantics: 'unified-plan'
                    }
                });
                
                peer.on('open', (id) => {
                    log(`Viewer ID: ${id}`);
                    
                    // é…ä¿¡è€…ã«æ¥ç¶š
                    connection = peer.connect(deviceId);
                    
                    connection.on('open', () => {
                        log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šç¢ºç«‹');
                        updateStatus('ğŸ“¡ ãƒ‡ãƒ¼ã‚¿æ¥ç¶šå®Œäº†', 'connected');
                        
                        // éŸ³å£°ãƒ»æ˜ åƒé€šè©±é–‹å§‹
                        call = peer.call(deviceId, new MediaStream());
                        
                        call.on('stream', (remoteStream) => {
                            log('è¶…ä½é…å»¶æ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡');
                            
                            // è¶…ä½é…å»¶æ˜ åƒè¡¨ç¤ºè¨­å®š
                            remoteVideo.srcObject = remoteStream;
                            remoteVideo.muted = true;
                            remoteVideo.autoplay = true;
                            remoteVideo.playsInline = true;
                            remoteVideo.setAttribute('playsinline', 'true');
                            
                            // GPUåŠ é€Ÿã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
                            remoteVideo.style.transform = 'translateZ(0)';
                            remoteVideo.style.willChange = 'transform';
                            remoteVideo.style.backfaceVisibility = 'hidden';
                            
                            // å…¨ç”»é¢è¡¨ç¤º
                            connectionPanel.classList.add('hidden');
                            loading.classList.add('hidden');
                            statsOverlay.classList.remove('hidden');
                            isConnected = true;
                            
                            showSuccessEffect();
                            updateStatus('ğŸ”´ è¶…ä½é…å»¶æ˜ åƒå—ä¿¡ä¸­', 'connected');
                            
                            // çµ±è¨ˆæƒ…å ±é–‹å§‹
                            startStats();
                            
                            // æ˜ åƒæƒ…å ±è¡¨ç¤º
                            const videoTrack = remoteStream.getVideoTracks()[0];
                            if (videoTrack) {
                                const settings = videoTrack.getSettings();
                                document.getElementById('resolution').textContent = 
                                    `${settings.width}x${settings.height}`;
                            }
                        });
                        
                        call.on('close', () => {
                            log('é€šè©±çµ‚äº†');
                            disconnect();
                        });
                        
                        call.on('error', (error) => {
                            log(`é€šè©±ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                            showError('æ˜ åƒã®å—ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                            disconnect();
                        });
                        
                        // è¶…ä½é…å»¶å—ä¿¡è¨­å®š
                        setupUltraLowLatencyReceiver(call);
                    });
                    
                    connection.on('data', (data) => {
                        log(`å—ä¿¡ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data)}`);
                    });
                    
                    connection.on('close', () => {
                        log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šçµ‚äº†');
                        disconnect();
                    });
                    
                    connection.on('error', (error) => {
                        log(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        showError('é…ä¿¡è€…ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
                        updateStatus('âŒ æ¥ç¶šå¤±æ•—', 'error');
                        loading.classList.add('hidden');
                        removeConnectingState();
                    });
                });
                
                peer.on('error', (error) => {
                    log(`Peer ã‚¨ãƒ©ãƒ¼: ${error.type} - ${error.message}`);
                    let errorMsg = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    
                    if (error.type === 'peer-unavailable') {
                        errorMsg = `${deviceName}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;
                    } else if (error.type === 'network') {
                        errorMsg = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã§ã™';
                    }
                    
                    showError(errorMsg);
                    updateStatus('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
                    loading.classList.add('hidden');
                    removeConnectingState();
                });
                
                // æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                setTimeout(() => {
                    if (!isConnected && peer) {
                        showError('æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                        disconnect();
                    }
                }, 20000);
                
            } catch (error) {
                log(`æ¥ç¶šé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showError('æ¥ç¶šã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                updateStatus('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'error');
                loading.classList.add('hidden');
                removeConnectingState();
            }
        }
        
        // è¶…ä½é…å»¶å—ä¿¡è¨­å®š
        async function setupUltraLowLatencyReceiver(call) {
            try {
                const pc = call.peerConnection;
                const receivers = pc.getReceivers();
                
                receivers.forEach(receiver => {
                    if (receiver.track && receiver.track.kind === 'video') {
                        log('ãƒ“ãƒ‡ã‚ªå—ä¿¡è€…ã®è¶…ä½é…å»¶è¨­å®š');
                        
                        // ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼ã®è¨­å®š
                        const transceiver = pc.getTransceivers().find(t => t.receiver === receiver);
                        if (transceiver) {
                            transceiver.direction = 'recvonly';
                            log('å—ä¿¡å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­å®šå®Œäº†');
                        }
                    }
                });
                
            } catch (error) {
                log(`è¶…ä½é…å»¶å—ä¿¡è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // çµ±è¨ˆæƒ…å ±é–‹å§‹
        function startStats() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            
            statsInterval = setInterval(async () => {
                if (call && call.peerConnection) {
                    try {
                        const stats = await call.peerConnection.getStats();
                        
                        let receiveBitrate = 0;
                        let receiveFps = 0;
                        let rtt = 0;
                        
                        stats.forEach(report => {
                            if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                if (report.bytesReceived) {
                                    receiveBitrate = Math.round((report.bytesReceived * 8) / 1000);
                                }
                                if (report.framesPerSecond) {
                                    receiveFps = Math.round(report.framesPerSecond);
                                }
                            }
                            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                if (report.currentRoundTripTime) {
                                    rtt = Math.round(report.currentRoundTripTime * 1000);
                                }
                            }
                        });
                        
                        document.getElementById('receiveBitrate').textContent = receiveBitrate + ' kbps';
                        document.getElementById('receiveFps').textContent = receiveFps + ' fps';
                        document.getElementById('latency').textContent = rtt + ' ms';
                        
                    } catch (error) {
                        log(`çµ±è¨ˆæƒ…å ±ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                }
            }, 1000);
        }
        
        // æ¥ç¶šä¸­çŠ¶æ…‹å‰Šé™¤
        function removeConnectingState() {
            const items = document.querySelectorAll('.device-item');
            items.forEach(item => item.classList.remove('connecting'));
        }
        
        // åˆ‡æ–­
        function disconnect() {
            if (call) {
                call.close();
                call = null;
            }
            
            if (connection) {
                connection.close();
                connection = null;
            }
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject = null;
            }
            
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            isConnected = false;
            
            connectionPanel.classList.remove('hidden');
            loading.classList.add('hidden');
            statsOverlay.classList.add('hidden');
            
            removeConnectingState();
            
            updateStatus('ğŸ“¡ é…ä¿¡ä¸­ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...', 'scanning');
            
            // å†æ¤œç´¢
            scanForDevices();
        }
        
        // å†æ¤œç´¢
        function refresh() {
            log('æ‰‹å‹•å†æ¤œç´¢');
            updateStatus('ğŸ“¡ é…ä¿¡ä¸­ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...', 'scanning');
            devices = {};
            updateDeviceList();
            scanForDevices();
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
        window.connectToDevice = connectToDevice;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        refreshBtn.addEventListener('click', refresh);
        disconnectBtn.addEventListener('click', disconnect);
        
        // å…¨ç”»é¢è¡¨ç¤ºæ™‚ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isConnected) {
                disconnect();
            }
        });
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('ğŸ“¡ é…ä¿¡ä¸­ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...', 'scanning');
            scanForDevices();
            log('è¶…ä½é…å»¶ã‚«ãƒ¡ãƒ©è¦–è´ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            disconnect();
        });
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            log(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${event.error}`);
            showError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        });
    </script>
</body>
</html> 