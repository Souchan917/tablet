<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>謎解き公演制御システム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <!-- PeerJS ライブラリ -->
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
</head>
<body>
    <!-- 初期選択画面 -->
    <div id="selection-screen" class="screen active">
        <div class="selection-container">
            <h1>謎解き公演制御システム</h1>
            <div class="button-grid">
                <button id="staff-btn" class="selection-btn staff-btn">スタッフ</button>
                <button id="master-btn" class="selection-btn master-btn">マスター</button>
                <button id="monitor-front-btn" class="selection-btn monitor-btn">モニター前</button>
                <button id="monitor-back-btn" class="selection-btn monitor-btn">モニター後</button>
                <button id="camera-btn" class="selection-btn camera-btn">カメラ</button>
                <button id="vehicle-btn" class="selection-btn vehicle-btn">車両番号</button>
            </div>
        </div>
    </div>

    <!-- スタッフ画面 -->
    <div id="staff-screen" class="screen">
        <div class="staff-container">
            <h2>スタッフ制御画面</h2>
            
            <!-- 現在のステップ表示 -->
            <div class="current-step-display">
                <h4>現在のステップ</h4>
                <div class="current-step-info" id="current-step-info">
                    ステップ1: 開始前
                </div>
            </div>

            <!-- チーム進捗管理 -->
            <div class="team-progress-section">
                <h3>チーム進捗管理（12チーム）</h3>
                <div class="team-grid" id="team-grid">
                    <!-- チームカードは JavaScript で動的に生成 -->
                </div>
                
                <div class="global-controls">
                    <button class="global-btn" id="next-all-teams">全チーム次へ</button>
                    <button class="global-btn" id="prev-all-teams">全チーム前へ</button>
                    <button class="global-btn reset" id="reset-all-teams">全チームリセット</button>
                </div>
            </div>

            <!-- 手動制御 -->
            <div class="control-panel">
                <div class="control-group">
                    <h3>手動制御</h3>
                    <button class="control-btn" id="manual-monitor-front">モニター前手動表示</button>
                    <button class="control-btn" id="manual-monitor-back">モニター後手動表示</button>
                    <input type="text" id="manual-vehicle-input" placeholder="車両番号を入力">
                    <button class="control-btn" id="manual-vehicle-send">車両番号手動送信</button>
                </div>
            </div>

            <button class="back-btn" id="back-from-staff">戻る</button>
        </div>
    </div>

    <!-- マスター画面 -->
    <div id="master-screen" class="screen">
        <div class="master-container">
            <h2>マスター制御画面</h2>
            <div class="master-controls">
                <div class="control-group">
                    <h3>車両番号制御</h3>
                    <div class="vehicle-control-panel">
                        <div class="vehicle-controls">
                            <button class="control-btn" id="decrementBtn">前の車両</button>
                            <input type="number" id="carInput" min="1" value="3600" placeholder="車両番号">
                            <button class="control-btn" id="incrementBtn">次の車両</button>
                            <button class="control-btn apply-btn" id="applyBtn">適用</button>
                        </div>
                        <div class="vehicle-status">
                            <span class="status-label">現在の車両番号:</span>
                            <span class="current-vehicle" id="currentVehicleNumber">3600</span>
                            <span class="status-label">自動減少:</span>
                            <span class="auto-status" id="autoStatus">停止中</span>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <h3>接続状況監視</h3>
                    <div class="connection-monitor-panel">
                        <div class="connection-summary" id="connection-summary">
                            <div class="summary-item">
                                <span class="summary-label">接続中端末:</span>
                                <span class="summary-value" id="connected-devices-count">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Firebase接続:</span>
                                <span class="summary-value" id="firebase-status">確認中...</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">最終更新:</span>
                                <span class="summary-value" id="last-update">---</span>
                            </div>
                        </div>
                        <div class="device-list" id="device-list">
                            <p>デバイス情報を読み込み中...</p>
                        </div>
                        <div class="connection-actions">
                            <button class="control-btn" id="refresh-connections">接続状況更新</button>
                            <button class="control-btn" id="test-all-communications">全端末通信テスト</button>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <h3>シンプル通信テスト</h3>
                    <div class="simple-communication-panel">
                        <div class="communication-status">
                            <div class="status-display">
                                <span class="status-label">通信状態:</span>
                                <span class="status-value" id="simple-comm-status">確認中...</span>
                            </div>
                            <div class="status-display">
                                <span class="status-label">接続デバイス:</span>
                                <span class="status-value" id="simple-comm-devices">0</span>
                            </div>
                        </div>
                        <div class="communication-buttons">
                            <button class="control-btn" id="simple-test-btn">テスト送信</button>
                            <button class="control-btn" id="simple-ping-btn">Ping送信</button>
                            <button class="control-btn" id="simple-refresh-btn">状態更新</button>
                        </div>
                        <div class="communication-log">
                            <h4>通信ログ</h4>
                            <div class="log-container" id="simple-comm-log">
                                <p>通信ログが表示されます</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <h3>その他の制御</h3>
                    <p>その他のマスター制御機能がここに表示されます</p>
                </div>
            </div>
            <button class="back-btn" id="back-from-master">戻る</button>
        </div>
    </div>

    <!-- モニター前画面 -->
    <div id="monitor-front-screen" class="screen">
        <div class="monitor-container">
            <h2>モニター前</h2>
            <div class="image-display" id="monitor-front-display">
                <p>画像がここに表示されます</p>
            </div>
            <!-- タップエリア -->
            <div class="tap-area-monitor" id="tap-area-monitor-front"></div>
            <button class="back-btn" id="back-from-monitor-front">戻る</button>
        </div>
    </div>

    <!-- モニター後画面 -->
    <div id="monitor-back-screen" class="screen">
        <div class="monitor-container">
            <h2>モニター後</h2>
            <div class="image-display" id="monitor-back-display">
                <p>画像がここに表示されます</p>
            </div>
            <!-- タップエリア -->
            <div class="tap-area-monitor" id="tap-area-monitor-back"></div>
            <button class="back-btn" id="back-from-monitor-back">戻る</button>
        </div>
    </div>

    <!-- カメラ画面 -->
    <div id="camera-screen" class="screen">
        <div class="camera-container">
            <!-- モード選択 -->
            <div class="camera-mode-selector" id="camera-mode-selector">
                <h3>カメラモードを選択</h3>
                <div class="mode-buttons">
                    <button id="broadcast-mode-btn" class="mode-button broadcast-mode">
                        <span class="mode-icon">📹</span>
                        <span class="mode-title">配信モード</span>
                        <span class="mode-desc">スマホ/GoProで撮影</span>
                    </button>
                    <button id="receive-mode-btn" class="mode-button receive-mode">
                        <span class="mode-icon">📺</span>
                        <span class="mode-title">受信モード</span>
                        <span class="mode-desc">タブレットで表示</span>
                    </button>
                </div>
            </div>

            <!-- 遅延カメラ映像表示エリア -->
            <div class="camera-view-container" id="camera-view-container">
                <video id="original-camera" autoplay muted style="display: none;"></video>
                <video id="delayed-camera" autoplay muted playsinline class="delayed-video"></video>
                <video id="remote-camera" autoplay muted playsinline class="delayed-video" style="display: none;"></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
            </div>
            
            <!-- 配信モード用コントロール -->
            <div class="camera-controls broadcast-controls" id="broadcast-controls">
                <div class="peer-info">
                    <div class="peer-id-display">
                        <span class="peer-label">配信ID:</span>
                        <span id="broadcast-peer-id" class="peer-id">接続中...</span>
                    </div>
                </div>
                
                <div class="camera-select-row">
                    <select id="camera-device-select">
                        <option value="">カメラを選択してください</option>
                    </select>
                    <button id="refresh-camera-btn" class="control-button">更新</button>
                </div>
                
                <div class="camera-buttons">
                    <button id="start-broadcast-btn" class="control-button primary">配信開始</button>
                    <button id="stop-broadcast-btn" class="control-button danger" disabled>配信停止</button>
                    <button id="fullscreen-camera-btn" class="control-button secondary">全画面</button>
                </div>
            </div>
            
            <!-- 受信モード用コントロール -->
            <div class="camera-controls receive-controls" id="receive-controls">
                <div class="peer-info">
                    <div class="peer-id-display">
                        <span class="peer-label">受信ID:</span>
                        <span id="receive-peer-id" class="peer-id">tabletcam</span>
                    </div>
                </div>
                
                <div class="delay-control">
                    <label for="camera-delay-slider">遅延:</label>
                    <input type="range" id="camera-delay-slider" min="0" max="50" value="10" step="1">
                    <span id="camera-delay-value">1.0秒</span>
                </div>
                
                <div class="camera-buttons">
                    <button id="start-receive-btn" class="control-button primary">受信開始</button>
                    <button id="stop-receive-btn" class="control-button danger" disabled>受信停止</button>
                    <button id="fullscreen-receive-btn" class="control-button secondary">全画面</button>
                </div>
            </div>
            
            <!-- ステータス表示 -->
            <div id="camera-status" class="camera-status">
                カメラモードを選択してください
            </div>
            
            <!-- タップエリア -->
            <div class="tap-area-camera" id="tap-area-camera"></div>
            <button class="back-btn" id="back-from-camera">戻る</button>
        </div>
    </div>

    <!-- 車両番号画面 -->
    <div id="vehicle-screen" class="screen">
        <div class="train-container">
            <div class="train-car-number-display">
                <div class="train-car-frame">
                    <div class="train-emblem">
                        <div class="emblem-inner">
                            <span class="emblem-text">GATANGO TRAIN</span>
                        </div>
                    </div>
                    <div class="car-number-container">
                        <div class="car-number" id="carNumber">3600</div>
                        <div class="car-suffix">号車</div>
                    </div>
                    <div class="car-name">GATANGO</div>
                </div>
            </div>
            
            <!-- 全画面表示ボタン -->
            <div class="fullscreen-button-container">
                <button class="fullscreen-btn" id="fullscreen-btn">全画面表示</button>
            </div>
            
            <!-- タップエリア -->
            <div class="tap-area-vehicle" id="tap-area-vehicle"></div>
        </div>
    </div>

    <!-- 接続状態インジケーター -->
    <div class="connection-indicator" id="connection-indicator"></div>
    
    <!-- Firebase SDK（V9 Compat mode） -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <!-- アプリケーションのJavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/simple-communication.js"></script>
    <script src="js/connection-manager.js"></script>
    <script src="js/app.js"></script>
</body>
</html> 