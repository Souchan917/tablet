<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½é…å»¶ã‚«ãƒ¡ãƒ©æ’®å½±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #1a1a1a;
            color: white;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .connection-mode {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .mode-title {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .network-settings {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        button {
            padding: 12px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .primary-btn {
            background-color: #2196F3;
            color: white;
        }
        
        .success-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .danger-btn {
            background-color: #f44336;
            color: white;
        }
        
        .warning-btn {
            background-color: #FF9800;
            color: white;
        }
        
        .latency-stats {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        
        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .status-bar {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin: 10px 0;
        }
        
        .connected {
            background-color: #2e7d32;
        }
        
        .connecting {
            background-color: #ef6c00;
        }
        
        .disconnected {
            background-color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ä½é…å»¶ã‚«ãƒ¡ãƒ©æ’®å½±</h1>
        
        <div class="status-bar disconnected" id="statusBar">
            æœªæ¥ç¶š
        </div>
        
        <div class="connection-mode">
            <div class="mode-title">ğŸ“¡ æ¥ç¶šæ–¹å¼é¸æŠ</div>
            <button class="primary-btn" id="ethernetMode">ğŸ”Œ Ethernetç›´æ¥æ¥ç¶š</button>
            <button class="warning-btn" id="wifiDirectMode">ğŸ“¶ Wi-Fi Direct</button>
            <button class="success-btn" id="dedicatedRouterMode">ğŸŒ å°‚ç”¨ãƒ«ãƒ¼ã‚¿ãƒ¼</button>
        </div>
        
        <div class="network-settings" id="networkSettings">
            <strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šï¼š</strong><br>
            <span id="networkInfo">æ¥ç¶šæ–¹å¼ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
        </div>
        
        <div class="controls">
            <button class="success-btn" id="startCamera">ğŸ“¹ ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <button class="primary-btn" id="generateId">ğŸ†” é…ä¿¡IDç”Ÿæˆ</button>
            <button class="danger-btn" id="stopCamera">â¹ï¸ åœæ­¢</button>
        </div>
        
        <div class="latency-stats" id="latencyStats">
            âš¡ é…å»¶çµ±è¨ˆ: æº–å‚™ä¸­...
        </div>
        
        <video id="localVideo" autoplay muted playsinline></video>
        
        <div class="network-settings">
            <strong>é…ä¿¡ID:</strong> <span id="broadcastId">æœªç”Ÿæˆ</span><br>
            <button class="primary-btn" id="copyId">ğŸ“‹ IDã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>

    <script>
        let localStream = null;
        let peerConnection = null;
        let currentMode = null;
        let broadcastId = null;
        let latencyMonitor = null;
        
        // è¶…ä½é…å»¶WebRTCè¨­å®š
        const ultraLowLatencyConfig = {
            iceServers: [
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å„ªå…ˆ
                { urls: 'stun:192.168.1.1:3478' },
                // å¿…è¦ã«å¿œã˜ã¦å¤–éƒ¨STUNã‚µãƒ¼ãƒãƒ¼ã‚’ç„¡åŠ¹åŒ–
            ],
            iceCandidatePoolSize: 0, // é«˜é€ŸåŒ–ã®ãŸã‚å‰Šæ¸›
            bundlePolicy: 'balanced',
            rtcpMuxPolicy: 'require',
            // å®Ÿé¨“çš„ãªä½é…å»¶è¨­å®š
            encodedInsertableStreams: false,
            forceEncodedAudioInsertableStreams: false,
            forceEncodedVideoInsertableStreams: false
        };
        
        // ä½é…å»¶ãƒ¡ãƒ‡ã‚£ã‚¢è¨­å®š
        const ultraLowLatencyMedia = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30 },
                facingMode: 'environment',
                // ä½é…å»¶æœ€é©åŒ–
                latency: { ideal: 0.01 }, // 10msç›®æ¨™
                resizeMode: 'crop-and-scale'
            },
            audio: false // æ˜ åƒã®ã¿ã§é…å»¶æœ€å°åŒ–
        };
        
        // UIè¦ç´ 
        const statusBar = document.getElementById('statusBar');
        const networkInfo = document.getElementById('networkInfo');
        const latencyStats = document.getElementById('latencyStats');
        const localVideo = document.getElementById('localVideo');
        const broadcastIdSpan = document.getElementById('broadcastId');
        
        // æ¥ç¶šæ–¹å¼é¸æŠ
        document.getElementById('ethernetMode').addEventListener('click', () => {
            setConnectionMode('ethernet');
        });
        
        document.getElementById('wifiDirectMode').addEventListener('click', () => {
            setConnectionMode('wifiDirect');
        });
        
        document.getElementById('dedicatedRouterMode').addEventListener('click', () => {
            setConnectionMode('dedicatedRouter');
        });
        
        // æ¥ç¶šæ–¹å¼è¨­å®š
        function setConnectionMode(mode) {
            currentMode = mode;
            
            switch(mode) {
                case 'ethernet':
                    networkInfo.innerHTML = `
                        <strong>Ethernetç›´æ¥æ¥ç¶š</strong><br>
                        ãƒ­ãƒ¼ã‚«ãƒ«IP: 192.168.1.1<br>
                        ç›¸æ‰‹ç«¯æœ«: 192.168.1.2<br>
                        äºˆæƒ³é…å»¶: 5-10ms
                    `;
                    // STUNã‚µãƒ¼ãƒãƒ¼ã‚’ç„¡åŠ¹åŒ–
                    ultraLowLatencyConfig.iceServers = [];
                    break;
                    
                case 'wifiDirect':
                    networkInfo.innerHTML = `
                        <strong>Wi-Fi Direct</strong><br>
                        ãƒ­ãƒ¼ã‚«ãƒ«IP: 192.168.49.1<br>
                        ç›¸æ‰‹ç«¯æœ«: 192.168.49.2<br>
                        äºˆæƒ³é…å»¶: 10-20ms
                    `;
                    ultraLowLatencyConfig.iceServers = [];
                    break;
                    
                case 'dedicatedRouter':
                    networkInfo.innerHTML = `
                        <strong>å°‚ç”¨ãƒ«ãƒ¼ã‚¿ãƒ¼</strong><br>
                        ãƒ«ãƒ¼ã‚¿ãƒ¼IP: 192.168.1.1<br>
                        5GHzå¸¯ã®ã¿ä½¿ç”¨<br>
                        äºˆæƒ³é…å»¶: 15-30ms
                    `;
                    ultraLowLatencyConfig.iceServers = [
                        { urls: 'stun:192.168.1.1:3478' }
                    ];
                    break;
            }
            
            statusBar.className = 'status-bar connecting';
            statusBar.textContent = `${mode}ãƒ¢ãƒ¼ãƒ‰è¨­å®šå®Œäº†`;
        }
        
        // é…ä¿¡IDç”Ÿæˆ
        document.getElementById('generateId').addEventListener('click', () => {
            broadcastId = `lowlatency-${Date.now()}`;
            broadcastIdSpan.textContent = broadcastId;
        });
        
        // IDã‚³ãƒ”ãƒ¼
        document.getElementById('copyId').addEventListener('click', () => {
            if (broadcastId) {
                navigator.clipboard.writeText(broadcastId);
                alert('é…ä¿¡IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        });
        
        // ã‚«ãƒ¡ãƒ©é–‹å§‹
        document.getElementById('startCamera').addEventListener('click', async () => {
            try {
                if (!currentMode) {
                    alert('æ¥ç¶šæ–¹å¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                if (!broadcastId) {
                    broadcastId = `lowlatency-${Date.now()}`;
                    broadcastIdSpan.textContent = broadcastId;
                }
                
                localStream = await navigator.mediaDevices.getUserMedia(ultraLowLatencyMedia);
                localVideo.srcObject = localStream;
                
                // WebRTCæ¥ç¶šæº–å‚™
                await setupWebRTCConnection();
                
                statusBar.className = 'status-bar connected';
                statusBar.textContent = 'æ’®å½±ä¸­ - ä½é…å»¶æœ€é©åŒ–æ¸ˆã¿';
                
                // é…å»¶ç›£è¦–é–‹å§‹
                startLatencyMonitoring();
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        });
        
        // WebRTCæ¥ç¶šè¨­å®š
        async function setupWebRTCConnection() {
            peerConnection = new RTCPeerConnection(ultraLowLatencyConfig);
            
            // é€ä¿¡è€…è¨­å®šã§ä½é…å»¶æœ€é©åŒ–
            localStream.getTracks().forEach(async track => {
                const sender = peerConnection.addTrack(track, localStream);
                
                // ä½é…å»¶ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼è¨­å®š
                if (track.kind === 'video') {
                    const params = sender.getParameters();
                    if (params.encodings && params.encodings.length > 0) {
                        params.encodings[0].maxBitrate = 2000000; // 2Mbps
                        params.encodings[0].maxFramerate = 30;
                        params.encodings[0].priority = 'high';
                        params.encodings[0].networkPriority = 'high';
                        await sender.setParameters(params);
                    }
                }
            });
            
            // æ¥ç¶šçŠ¶æ…‹ç›£è¦–
            peerConnection.onconnectionstatechange = () => {
                console.log('æ¥ç¶šçŠ¶æ…‹:', peerConnection.connectionState);
                updateConnectionStatus(peerConnection.connectionState);
            };
        }
        
        // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
        function updateConnectionStatus(state) {
            switch(state) {
                case 'connected':
                    statusBar.className = 'status-bar connected';
                    statusBar.textContent = 'æ¥ç¶šå®Œäº† - ä½é…å»¶é€šä¿¡ä¸­';
                    break;
                case 'connecting':
                    statusBar.className = 'status-bar connecting';
                    statusBar.textContent = 'æ¥ç¶šä¸­...';
                    break;
                case 'disconnected':
                case 'failed':
                    statusBar.className = 'status-bar disconnected';
                    statusBar.textContent = 'æ¥ç¶šåˆ‡æ–­';
                    break;
            }
        }
        
        // é…å»¶ç›£è¦–
        function startLatencyMonitoring() {
            if (!peerConnection) return;
            
            latencyMonitor = setInterval(async () => {
                try {
                    const stats = await peerConnection.getStats();
                    let latencyInfo = '';
                    let bitrate = 0;
                    let fps = 0;
                    let rtt = 0;
                    
                    stats.forEach(report => {
                        if (report.type === 'outbound-rtp' && report.kind === 'video') {
                            fps = report.framesPerSecond || 0;
                            bitrate = Math.round((report.bytesSent || 0) / 1024);
                        }
                        
                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            rtt = Math.round((report.currentRoundTripTime || 0) * 1000);
                        }
                    });
                    
                    latencyInfo = `
                        ğŸ¯ RTT: ${rtt}ms | ğŸ“Š FPS: ${fps} | ğŸš€ é€ä¿¡: ${bitrate} KB/s
                        ğŸ“¡ æ¥ç¶š: ${currentMode} | ğŸ”— çŠ¶æ…‹: ${peerConnection.connectionState}
                    `;
                    
                    latencyStats.textContent = latencyInfo;
                    
                } catch (error) {
                    console.error('é…å»¶ç›£è¦–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }, 1000);
        }
        
        // åœæ­¢
        document.getElementById('stopCamera').addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (latencyMonitor) {
                clearInterval(latencyMonitor);
                latencyMonitor = null;
            }
            
            statusBar.className = 'status-bar disconnected';
            statusBar.textContent = 'åœæ­¢æ¸ˆã¿';
        });
        
        // åˆæœŸè¨­å®š
        networkInfo.textContent = 'æ¥ç¶šæ–¹å¼ã‚’é¸æŠã—ã¦ãã ã•ã„';
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
        });
    </script>
</body>
</html> 