<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>モニター前 - 謎解きシステム</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">← 戻る</button>
    
    <div class="container">
        <h1>モニター前</h1>
        
        <div class="image-display" id="imageDisplay">
            <img id="progressImage" src="" alt="進捗画像" style="display: none;">
            <p id="loadingText">画像を読み込み中...</p>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="fullscreenBtn">全画面表示</button>
            <button class="control-btn" id="refreshBtn">更新</button>
        </div>
        
        <div class="team-selector">
            <label for="teamSelect">表示チーム:</label>
            <select id="teamSelect">
                <option value="auto">自動（最高進捗）</option>
                <option value="1">チーム1</option>
                <option value="2">チーム2</option>
                <option value="3">チーム3</option>
                <option value="4">チーム4</option>
                <option value="5">チーム5</option>
                <option value="6">チーム6</option>
                <option value="7">チーム7</option>
                <option value="8">チーム8</option>
                <option value="9">チーム9</option>
                <option value="10">チーム10</option>
                <option value="11">チーム11</option>
            </select>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="js/app.js"></script>
    <script>
        let teams = [];
        let unsubscribeTeams = null;
        let currentDisplayTeam = 'auto';

        // 画像を更新
        function updateImage() {
            const teamSelect = document.getElementById('teamSelect');
            const selectedTeam = teamSelect.value;
            
            let targetProgress = 0;
            
            if (selectedTeam === 'auto') {
                // 最高進捗のチームを選択
                const maxProgress = Math.max(...teams.map(t => t.progress));
                targetProgress = maxProgress;
            } else {
                // 指定されたチームの進捗を使用
                const team = teams.find(t => t.id === parseInt(selectedTeam));
                targetProgress = team ? team.progress : 0;
            }
            
            // 画像パスを生成
            const imagePath = `images/front/progress_${targetProgress}.jpg`;
            
            // 画像を表示
            const img = document.getElementById('progressImage');
            const loadingText = document.getElementById('loadingText');
            
            img.onload = function() {
                loadingText.style.display = 'none';
                img.style.display = 'block';
            };
            
            img.onerror = function() {
                loadingText.textContent = `画像が見つかりません: ${imagePath}`;
                img.style.display = 'none';
                loadingText.style.display = 'block';
            };
            
            img.src = imagePath;
        }

        // 全画面表示
        function toggleFullscreen() {
            const imageDisplay = document.getElementById('imageDisplay');
            
            if (!document.fullscreenElement) {
                imageDisplay.requestFullscreen().catch(err => {
                    console.error('フルスクリーン表示に失敗:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // チーム進捗の変更を監視
        function watchTeamChanges() {
            unsubscribeTeams = window.PuzzleSystem.watchTeamProgress((updatedTeams) => {
                teams = updatedTeams;
                updateImage();
            });
        }

        // 戻るボタン
        function goBack() {
            if (unsubscribeTeams) {
                unsubscribeTeams();
            }
            window.location.href = 'index.html';
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // チーム初期化
            teams = [];
            for (let i = 1; i <= 11; i++) {
                teams.push({
                    id: i,
                    name: `チーム${i}`,
                    progress: 0,
                    maxProgress: 10
                });
            }
            
            // Firebase接続後に進捗を読み込み
            setTimeout(async () => {
                await window.PuzzleSystem.loadTeamProgress();
                watchTeamChanges();
                updateImage();
            }, 1000);
            
            // イベントリスナーを追加
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('refreshBtn').addEventListener('click', updateImage);
            document.getElementById('teamSelect').addEventListener('change', updateImage);
            
            // 画像クリックでも全画面表示
            document.getElementById('imageDisplay').addEventListener('click', toggleFullscreen);
        });

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', function() {
            if (unsubscribeTeams) {
                unsubscribeTeams();
            }
        });
    </script>
</body>
</html> 