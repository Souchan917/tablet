<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTCãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background-color: #222;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background-color: #9AFF9A;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #7FFF7F;
        }
        button:disabled {
            background-color: #666;
            color: #999;
            cursor: not-allowed;
        }
        /* ä½é…å»¶ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        button[onclick*="LowLatency"], button[onclick*="lowLatency"] {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }
        button[onclick*="LowLatency"]:hover, button[onclick*="lowLatency"]:hover {
            background: linear-gradient(45deg, #FF5252, #FF7979);
        }
        input {
            background-color: #333;
            color: #fff;
            border: 2px solid #9AFF9A;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
            width: 300px;
        }
        video {
            width: 100%;
            max-width: 400px;
            background-color: #000;
            border: 1px solid #444;
        }
        .status {
            background-color: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .logs {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª WebRTCæ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>1. PeerJSåŸºæœ¬ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="initPeer()">PeerJSåˆæœŸåŒ–</button>
            <button onclick="initLowLatencyPeer()">ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–</button>
            <button onclick="startCamera()">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <button onclick="startLowLatencyCamera()">ğŸš€ ä½é…å»¶ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <div class="status">
                <div>è‡ªåˆ†ã®ID: <span id="myId">æœªåˆæœŸåŒ–</span></div>
                <div>æ¥ç¶šçŠ¶æ…‹: <span id="peerStatus">æœªæ¥ç¶š</span></div>
                <div>ãƒ¢ãƒ¼ãƒ‰: <span id="modeStatus">é€šå¸¸</span></div>
            </div>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        
        <div class="test-section">
            <h2>2. æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <input type="text" id="targetId" placeholder="æ¥ç¶šå…ˆã®IDã‚’å…¥åŠ›">
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <button onclick="connectToTarget()">é€šè©±é–‹å§‹</button>
            <button onclick="connectLowLatency()">ğŸš€ ä½é…å»¶é€šè©±é–‹å§‹</button>
            <div class="status">
                <div>æ¥ç¶šå…ˆ: <span id="targetStatus">æœªæ¥ç¶š</span></div>
                <div>é€šè©±ãƒ¢ãƒ¼ãƒ‰: <span id="callMode">æœªè¨­å®š</span></div>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        
        <div class="test-section">
            <h2>3. çµ±è¨ˆæƒ…å ±</h2>
            <button onclick="startStats()">çµ±è¨ˆé–‹å§‹</button>
            <button onclick="stopStats()">çµ±è¨ˆåœæ­¢</button>
            <div class="status">
                <div>é€ä¿¡ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ: <span id="sendBitrate">--- kbps</span></div>
                <div>å—ä¿¡ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ: <span id="receiveBitrate">--- kbps</span></div>
                <div>é€ä¿¡FPS: <span id="sendFps">--- fps</span></div>
                <div>å—ä¿¡FPS: <span id="receiveFps">--- fps</span></div>
                <div>ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹: <span id="packetLoss">--- %</span></div>
                <div>é…å»¶: <span id="rtt">--- ms</span></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>4. ãƒ­ã‚°</h2>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer = null;
        let localStream = null;
        let call = null;
        let isLowLatencyMode = false;
        let statsInterval = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function initPeer() {
            const peerId = 'test-' + Math.random().toString(36).substr(2, 9);
            log('ğŸ”„ PeerJSåˆæœŸåŒ–é–‹å§‹: ' + peerId);
            
            peer = new Peer(peerId, {
                debug: 1
            });
            
            isLowLatencyMode = false;
            document.getElementById('modeStatus').textContent = 'é€šå¸¸';
            
            peer.on('open', function(id) {
                log('âœ… PeerJSæ¥ç¶šæˆåŠŸ: ' + id);
                document.getElementById('myId').textContent = id;
                document.getElementById('peerStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
            });
            
            peer.on('call', function(incomingCall) {
                log('ğŸ“ ç€ä¿¡: ' + incomingCall.peer);
                if (localStream) {
                    incomingCall.answer(localStream);
                    setupCallEvents(incomingCall);
                }
            });
            
            peer.on('connection', function(conn) {
                log('ğŸ“¡ ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: ' + conn.peer);
                conn.on('open', function() {
                    log('âœ… ãƒ‡ãƒ¼ã‚¿æ¥ç¶šé–‹å§‹');
                    conn.send('Hello from ' + peer.id);
                });
                conn.on('data', function(data) {
                    log('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å—ä¿¡: ' + data);
                });
            });
            
            peer.on('error', function(err) {
                log('âŒ PeerJSã‚¨ãƒ©ãƒ¼: ' + err.type + ' - ' + err.message);
                document.getElementById('peerStatus').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.type;
            });
        }
        
        function initLowLatencyPeer() {
            const peerId = 'test-lowlatency-' + Math.random().toString(36).substr(2, 9);
            log('ğŸš€ ä½é…å»¶PeerJSåˆæœŸåŒ–é–‹å§‹: ' + peerId);
            
            // ä½é…å»¶æœ€é©åŒ–ã•ã‚ŒãŸPeerJSè¨­å®š
            peer = new Peer(peerId, {
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ],
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-compat',
                    rtcpMuxPolicy: 'require',
                    iceCandidatePoolSize: 10,
                    // ä½é…å»¶ã«é‡è¦ãªè¨­å®š
                    sdpSemantics: 'unified-plan'
                }
            });
            
            isLowLatencyMode = true;
            document.getElementById('modeStatus').textContent = 'ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰';
            
            peer.on('open', function(id) {
                log('âœ… ä½é…å»¶PeerJSæ¥ç¶šæˆåŠŸ: ' + id);
                document.getElementById('myId').textContent = id;
                document.getElementById('peerStatus').textContent = 'æ¥ç¶šæ¸ˆã¿ (ä½é…å»¶)';
            });
            
            peer.on('call', function(incomingCall) {
                log('ğŸš€ ä½é…å»¶ç€ä¿¡: ' + incomingCall.peer);
                if (localStream) {
                    incomingCall.answer(localStream);
                    setupLowLatencyCallEvents(incomingCall);
                }
            });
            
            peer.on('connection', function(conn) {
                log('ğŸ“¡ ä½é…å»¶ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: ' + conn.peer);
                conn.on('open', function() {
                    log('âœ… ä½é…å»¶ãƒ‡ãƒ¼ã‚¿æ¥ç¶šé–‹å§‹');
                    conn.send('Hello from low-latency ' + peer.id);
                });
                conn.on('data', function(data) {
                    log('ğŸ“¥ ä½é…å»¶ãƒ‡ãƒ¼ã‚¿å—ä¿¡: ' + data);
                });
            });
            
            peer.on('error', function(err) {
                log('âŒ ä½é…å»¶PeerJSã‚¨ãƒ©ãƒ¼: ' + err.type + ' - ' + err.message);
                document.getElementById('peerStatus').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.type;
            });
        }
        
        async function startCamera() {
            try {
                log('ğŸ“¹ ã‚«ãƒ¡ãƒ©é–‹å§‹...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                log('âœ… ã‚«ãƒ¡ãƒ©é–‹å§‹æˆåŠŸ');
                
            } catch (error) {
                log('âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        async function startLowLatencyCamera() {
            try {
                log('ğŸš€ ä½é…å»¶ã‚«ãƒ¡ãƒ©é–‹å§‹...');
                
                // ä½é…å»¶æœ€é©åŒ–ã•ã‚ŒãŸã‚«ãƒ¡ãƒ©è¨­å®š
                const constraints = {
                    video: {
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 60, max: 60 },
                        facingMode: 'user',
                        // ä½é…å»¶ã«é‡è¦ãªè¨­å®š
                        latency: { ideal: 0.01 },
                        aspectRatio: { ideal: 16/9 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        // ä½é…å»¶ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®š
                        latency: { ideal: 0.01 },
                        channelCount: { ideal: 2, max: 2 },
                        sampleRate: { ideal: 48000 },
                        sampleSize: { ideal: 16 }
                    }
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('localVideo');
                video.srcObject = localStream;
                
                // ä½é…å»¶ã®ãŸã‚ã®ãƒ“ãƒ‡ã‚ªè¨­å®š
                video.muted = true;
                video.autoplay = true;
                video.playsInline = true;
                video.setAttribute('playsinline', 'true');
                
                // GPUåŠ é€Ÿã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
                if (video.style) {
                    video.style.transform = 'translateZ(0)';
                    video.style.willChange = 'transform';
                    video.style.backfaceVisibility = 'hidden';
                }
                
                log('âœ… ä½é…å»¶ã‚«ãƒ¡ãƒ©é–‹å§‹æˆåŠŸ');
                
                // ã‚«ãƒ¡ãƒ©è¨­å®šã®è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    log('ğŸ“Š ã‚«ãƒ¡ãƒ©è¨­å®š: ' + settings.width + 'x' + settings.height + ' @' + settings.frameRate + 'fps');
                }
                
            } catch (error) {
                log('âŒ ä½é…å»¶ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        function testConnection() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) {
                alert('æ¥ç¶šå…ˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!peer) {
                log('âŒ PeerJSãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹: ' + targetId);
            
            const conn = peer.connect(targetId);
            
            conn.on('open', function() {
                log('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + targetId);
                document.getElementById('targetStatus').textContent = 'æ¥ç¶šå¯èƒ½';
                conn.close();
            });
            
            conn.on('error', function(error) {
                log('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error);
                document.getElementById('targetStatus').textContent = 'æ¥ç¶šå¤±æ•—';
            });
            
            setTimeout(() => {
                if (conn.open === false) {
                    log('â° æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                    document.getElementById('targetStatus').textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ';
                }
            }, 5000);
        }
        
        function connectToTarget() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) {
                alert('æ¥ç¶šå…ˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!peer || !localStream) {
                log('âŒ PeerJSã¾ãŸã¯ã‚«ãƒ¡ãƒ©ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('ğŸ“ é€šè©±é–‹å§‹: ' + targetId);
            call = peer.call(targetId, localStream);
            document.getElementById('callMode').textContent = 'é€šå¸¸é€šè©±';
            setupCallEvents(call);
        }
        
        function connectLowLatency() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) {
                alert('æ¥ç¶šå…ˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!peer || !localStream) {
                log('âŒ PeerJSã¾ãŸã¯ã‚«ãƒ¡ãƒ©ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('ğŸš€ ä½é…å»¶é€šè©±é–‹å§‹: ' + targetId);
            call = peer.call(targetId, localStream);
            document.getElementById('callMode').textContent = 'ä½é…å»¶é€šè©±';
            setupLowLatencyCallEvents(call);
        }
        
        function setupCallEvents(call) {
            call.on('stream', function(remoteStream) {
                log('ğŸ“º ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡');
                document.getElementById('remoteVideo').srcObject = remoteStream;
                document.getElementById('targetStatus').textContent = 'é€šè©±ä¸­';
            });
            
            call.on('close', function() {
                log('ğŸ“´ é€šè©±çµ‚äº†');
                document.getElementById('targetStatus').textContent = 'åˆ‡æ–­';
                document.getElementById('callMode').textContent = 'æœªè¨­å®š';
            });
            
            call.on('error', function(error) {
                log('âŒ é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error);
                document.getElementById('targetStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
                document.getElementById('callMode').textContent = 'æœªè¨­å®š';
            });
        }
        
        async function setupLowLatencyCallEvents(call) {
            call.on('stream', function(remoteStream) {
                log('ğŸš€ ä½é…å»¶ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡');
                
                // å—ä¿¡å´ã®ä½é…å»¶è¨­å®š
                try {
                    const pc = call.peerConnection;
                    
                    // å—ä¿¡è€…ã®ä½é…å»¶è¨­å®š
                    const receivers = pc.getReceivers();
                    receivers.forEach(receiver => {
                        if (receiver.track && receiver.track.kind === 'video') {
                            log('ğŸ¯ ãƒ“ãƒ‡ã‚ªå—ä¿¡è€…ã®ä½é…å»¶è¨­å®š');
                            
                            // ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼ã®è¨­å®š
                            const transceiver = pc.getTransceivers().find(t => t.receiver === receiver);
                            if (transceiver) {
                                transceiver.direction = 'recvonly';
                                log('âœ… å—ä¿¡å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
                            }
                        }
                    });
                    
                    // é€ä¿¡è€…ã®ä½é…å»¶è¨­å®š
                    const senders = pc.getSenders();
                    senders.forEach(async sender => {
                        if (sender.track && sender.track.kind === 'video') {
                            const params = sender.getParameters();
                            
                            if (params.encodings && params.encodings.length > 0) {
                                params.encodings.forEach(encoding => {
                                    // ä½é…å»¶ã«æœ€é©åŒ–
                                    encoding.maxBitrate = 3000000; // 3Mbps
                                    encoding.maxFramerate = 60; // 60fpså¯¾å¿œ
                                    encoding.scaleResolutionDownBy = 1; // è§£åƒåº¦ç¶­æŒ
                                    encoding.priority = 'high'; // é«˜å„ªå…ˆåº¦
                                });
                                
                                try {
                                    await sender.setParameters(params);
                                    log('âœ… ä½é…å»¶ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šå®Œäº†');
                                } catch (e) {
                                    log('âš ï¸ ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šå¤±æ•—: ' + e.message);
                                }
                            }
                            
                            // è¿½åŠ ã®ä½é…å»¶è¨­å®š
                            const transceiver = pc.getTransceivers().find(t => t.sender === sender);
                            if (transceiver) {
                                transceiver.direction = 'sendonly';
                                log('âœ… é€ä¿¡å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
                            }
                        }
                        
                        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®ä½é…å»¶è¨­å®š
                        if (sender.track && sender.track.kind === 'audio') {
                            const params = sender.getParameters();
                            if (params.encodings && params.encodings.length > 0) {
                                params.encodings.forEach(encoding => {
                                    encoding.priority = 'high';
                                    encoding.maxBitrate = 128000; // 128kbps
                                });
                                try {
                                    await sender.setParameters(params);
                                    log('âœ… ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªä½é…å»¶è¨­å®šå®Œäº†');
                                } catch (e) {
                                    log('âš ï¸ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¨­å®šå¤±æ•—: ' + e.message);
                                }
                            }
                        }
                    });
                    
                } catch (error) {
                    log('âš ï¸ ä½é…å»¶è¨­å®šã®ä¸€éƒ¨ãŒå¤±æ•—: ' + error.message);
                }
                
                // ä½é…å»¶ã®ãŸã‚ã®ãƒ“ãƒ‡ã‚ªè¡¨ç¤ºæœ€é©åŒ–
                const video = document.getElementById('remoteVideo');
                video.srcObject = remoteStream;
                video.muted = true;
                video.autoplay = true;
                video.playsInline = true;
                video.setAttribute('playsinline', 'true');
                
                // GPUåŠ é€Ÿã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
                if (video.style) {
                    video.style.transform = 'translateZ(0)';
                    video.style.willChange = 'transform';
                    video.style.backfaceVisibility = 'hidden';
                }
                
                document.getElementById('targetStatus').textContent = 'ä½é…å»¶é€šè©±ä¸­';
            });
            
            call.on('close', function() {
                log('ğŸ“´ ä½é…å»¶é€šè©±çµ‚äº†');
                document.getElementById('targetStatus').textContent = 'åˆ‡æ–­';
                document.getElementById('callMode').textContent = 'æœªè¨­å®š';
            });
            
            call.on('error', function(error) {
                log('âŒ ä½é…å»¶é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error);
                document.getElementById('targetStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
                document.getElementById('callMode').textContent = 'æœªè¨­å®š';
            });
        }
        
        // çµ±è¨ˆæƒ…å ±ã®é–‹å§‹
        function startStats() {
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            
            if (!call || !call.peerConnection) {
                log('âŒ é€šè©±ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('ğŸ“Š çµ±è¨ˆæƒ…å ±ç›£è¦–é–‹å§‹');
            
            statsInterval = setInterval(async () => {
                try {
                    const stats = await call.peerConnection.getStats();
                    
                    let sendBitrate = 0;
                    let receiveBitrate = 0;
                    let sendFps = 0;
                    let receiveFps = 0;
                    let packetLoss = 0;
                    let rtt = 0;
                    
                    stats.forEach(report => {
                        if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                            sendBitrate = Math.round(report.bytesSent * 8 / 1000);
                            sendFps = report.framesPerSecond || 0;
                        }
                        
                        if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                            receiveBitrate = Math.round(report.bytesReceived * 8 / 1000);
                            receiveFps = report.framesPerSecond || 0;
                            
                            const packetsLost = report.packetsLost || 0;
                            const packetsReceived = report.packetsReceived || 1;
                            packetLoss = ((packetsLost / (packetsLost + packetsReceived)) * 100).toFixed(2);
                        }
                        
                        if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                            rtt = report.currentRoundTripTime ? Math.round(report.currentRoundTripTime * 1000) : 0;
                        }
                    });
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
                    document.getElementById('sendBitrate').textContent = sendBitrate + ' kbps';
                    document.getElementById('receiveBitrate').textContent = receiveBitrate + ' kbps';
                    document.getElementById('sendFps').textContent = sendFps + ' fps';
                    document.getElementById('receiveFps').textContent = receiveFps + ' fps';
                    document.getElementById('packetLoss').textContent = packetLoss + ' %';
                    document.getElementById('rtt').textContent = rtt + ' ms';
                    
                    // ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›
                    if (isLowLatencyMode) {
                        log('ğŸš€ ä½é…å»¶çµ±è¨ˆ: ' + sendBitrate + 'kbpsâ†‘ ' + receiveBitrate + 'kbpsâ†“ ' + sendFps + 'fpsâ†‘ ' + receiveFps + 'fpsâ†“ RTT:' + rtt + 'ms');
                    }
                    
                } catch (error) {
                    log('âŒ çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }, 1000);
        }
        
        // çµ±è¨ˆæƒ…å ±ã®åœæ­¢
        function stopStats() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
                log('ğŸ“Š çµ±è¨ˆæƒ…å ±ç›£è¦–åœæ­¢');
            }
        }
        
        // åˆæœŸåŒ–
        log('ğŸš€ WebRTCãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸é–‹å§‹');
        log('æ‰‹é †: 1) PeerJSåˆæœŸåŒ– â†’ 2) ã‚«ãƒ¡ãƒ©é–‹å§‹ â†’ 3) IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦åˆ¥ã‚¿ãƒ–ã§å…±æœ‰');
        log('ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰: ä½é…å»¶åˆæœŸåŒ– â†’ ä½é…å»¶ã‚«ãƒ¡ãƒ© â†’ ä½é…å»¶é€šè©± â†’ çµ±è¨ˆé–‹å§‹');
    </script>
</body>
</html> 