<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTCãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background-color: #222;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        button {
            background-color: #9AFF9A;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover {
            background-color: #7FFF7F;
        }
        button:disabled {
            background-color: #666;
            color: #999;
            cursor: not-allowed;
        }
        input {
            background-color: #333;
            color: #fff;
            border: 2px solid #9AFF9A;
            padding: 8px;
            border-radius: 4px;
            margin: 5px;
            width: 300px;
        }
        video {
            width: 100%;
            max-width: 400px;
            background-color: #000;
            border: 1px solid #444;
        }
        .status {
            background-color: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .logs {
            background-color: #111;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª WebRTCæ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>1. PeerJSåŸºæœ¬ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="initPeer()">PeerJSåˆæœŸåŒ–</button>
            <button onclick="startCamera()">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <div class="status">
                <div>è‡ªåˆ†ã®ID: <span id="myId">æœªåˆæœŸåŒ–</span></div>
                <div>æ¥ç¶šçŠ¶æ…‹: <span id="peerStatus">æœªæ¥ç¶š</span></div>
            </div>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        
        <div class="test-section">
            <h2>2. æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <input type="text" id="targetId" placeholder="æ¥ç¶šå…ˆã®IDã‚’å…¥åŠ›">
            <button onclick="testConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <button onclick="connectToTarget()">é€šè©±é–‹å§‹</button>
            <div class="status">
                <div>æ¥ç¶šå…ˆ: <span id="targetStatus">æœªæ¥ç¶š</span></div>
            </div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        
        <div class="test-section">
            <h2>3. ãƒ­ã‚°</h2>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer = null;
        let localStream = null;
        let call = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function initPeer() {
            const peerId = 'test-' + Math.random().toString(36).substr(2, 9);
            log('ğŸ”„ PeerJSåˆæœŸåŒ–é–‹å§‹: ' + peerId);
            
            peer = new Peer(peerId, {
                debug: 1
            });
            
            peer.on('open', function(id) {
                log('âœ… PeerJSæ¥ç¶šæˆåŠŸ: ' + id);
                document.getElementById('myId').textContent = id;
                document.getElementById('peerStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
            });
            
            peer.on('call', function(incomingCall) {
                log('ğŸ“ ç€ä¿¡: ' + incomingCall.peer);
                if (localStream) {
                    incomingCall.answer(localStream);
                    setupCallEvents(incomingCall);
                }
            });
            
            peer.on('connection', function(conn) {
                log('ğŸ“¡ ãƒ‡ãƒ¼ã‚¿æ¥ç¶š: ' + conn.peer);
                conn.on('open', function() {
                    log('âœ… ãƒ‡ãƒ¼ã‚¿æ¥ç¶šé–‹å§‹');
                    conn.send('Hello from ' + peer.id);
                });
                conn.on('data', function(data) {
                    log('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å—ä¿¡: ' + data);
                });
            });
            
            peer.on('error', function(err) {
                log('âŒ PeerJSã‚¨ãƒ©ãƒ¼: ' + err.type + ' - ' + err.message);
                document.getElementById('peerStatus').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.type;
            });
        }
        
        async function startCamera() {
            try {
                log('ğŸ“¹ ã‚«ãƒ¡ãƒ©é–‹å§‹...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                log('âœ… ã‚«ãƒ¡ãƒ©é–‹å§‹æˆåŠŸ');
                
            } catch (error) {
                log('âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        function testConnection() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) {
                alert('æ¥ç¶šå…ˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!peer) {
                log('âŒ PeerJSãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹: ' + targetId);
            
            const conn = peer.connect(targetId);
            
            conn.on('open', function() {
                log('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ: ' + targetId);
                document.getElementById('targetStatus').textContent = 'æ¥ç¶šå¯èƒ½';
                conn.close();
            });
            
            conn.on('error', function(error) {
                log('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error);
                document.getElementById('targetStatus').textContent = 'æ¥ç¶šå¤±æ•—';
            });
            
            setTimeout(() => {
                if (conn.open === false) {
                    log('â° æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                    document.getElementById('targetStatus').textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ';
                }
            }, 5000);
        }
        
        function connectToTarget() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) {
                alert('æ¥ç¶šå…ˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!peer || !localStream) {
                log('âŒ PeerJSã¾ãŸã¯ã‚«ãƒ¡ãƒ©ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('ğŸ“ é€šè©±é–‹å§‹: ' + targetId);
            call = peer.call(targetId, localStream);
            setupCallEvents(call);
        }
        
        function setupCallEvents(call) {
            call.on('stream', function(remoteStream) {
                log('ğŸ“º ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡');
                document.getElementById('remoteVideo').srcObject = remoteStream;
                document.getElementById('targetStatus').textContent = 'é€šè©±ä¸­';
            });
            
            call.on('close', function() {
                log('ğŸ“´ é€šè©±çµ‚äº†');
                document.getElementById('targetStatus').textContent = 'åˆ‡æ–­';
            });
            
            call.on('error', function(error) {
                log('âŒ é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error);
                document.getElementById('targetStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
            });
        }
        
        // åˆæœŸåŒ–
        log('ğŸš€ WebRTCãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸é–‹å§‹');
        log('æ‰‹é †: 1) PeerJSåˆæœŸåŒ– â†’ 2) ã‚«ãƒ¡ãƒ©é–‹å§‹ â†’ 3) IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦åˆ¥ã‚¿ãƒ–ã§å…±æœ‰');
    </script>
</body>
</html> 