<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©æ˜ åƒ - è¬è§£ãã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
    
    <div class="container">
        <h1>ã‚«ãƒ¡ãƒ©æ˜ åƒ</h1>
        
        <div class="camera-container">
            <div class="video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <canvas id="delayCanvas" style="display: none;"></canvas>
                <p id="statusText">é…ä¿¡ã«æ¥ç¶šä¸­...</p>
            </div>
            
            <div class="delay-controls">
                <label for="delaySlider">é…å»¶æ™‚é–“:</label>
                <input type="range" id="delaySlider" min="0" max="30" value="5" step="1" class="delay-slider">
                <span id="delayValue">5ç§’</span>
            </div>
            
            <div class="broadcast-id-input">
                <label for="broadcastIdInput">é…ä¿¡ID:</label>
                <input type="text" id="broadcastIdInput" placeholder="é…ä¿¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="width: 300px; padding: 8px; margin: 0 10px;">
                <button class="camera-btn" id="pasteIdBtn">è²¼ã‚Šä»˜ã‘</button>
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn" id="connectBtn">æ¥ç¶šé–‹å§‹</button>
                <button class="camera-btn" id="disconnectBtn" disabled>æ¥ç¶šçµ‚äº†</button>
                <button class="camera-btn" id="fullscreenBtn">å…¨ç”»é¢è¡¨ç¤º</button>
                <button class="camera-btn" id="recordBtn" disabled>éŒ²ç”»é–‹å§‹</button>
            </div>
            
            <div class="connection-info">
                <h3>æ¥ç¶šæƒ…å ±</h3>
                <p>å—ä¿¡ID: <span id="peerId">æº–å‚™ä¸­...</span></p>
                <p>æ¥ç¶šçŠ¶æ…‹: <span id="connectionStatus">æº–å‚™ä¸­</span></p>
                <p>é…å»¶çŠ¶æ…‹: <span id="delayStatus">ç„¡åŠ¹</span></p>
                <p>ãƒãƒƒãƒ•ã‚¡çŠ¶æ…‹: <span id="bufferStatus">---</span></p>
            </div>
            
            <div class="receive-stats">
                <h3>å—ä¿¡çµ±è¨ˆ</h3>
                <p>å—ä¿¡ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ: <span id="receiveBitrateStats">--- kbps</span></p>
                <p>å—ä¿¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: <span id="receiveFpsStats">--- fps</span></p>
                <p>ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹: <span id="packetLossStats">--- %</span></p>
            </div>
            
            <div class="troubleshooting">
                <h3>âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
                <ul>
                    <li><strong>é…ä¿¡ID:</strong> é…ä¿¡å´ã‹ã‚‰æ­£ã—ã„IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘</li>
                    <li><strong>æ¥ç¶šé †åº:</strong> é…ä¿¡å´ã‚’å…ˆã«é–‹å§‹ã—ã¦ã‹ã‚‰å—ä¿¡å´ã‚’æ¥ç¶š</li>
                    <li><strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:</strong> åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±</li>
                    <li><strong>ãƒ‡ãƒãƒƒã‚°:</strong> é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª</li>
                    <li><strong>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:</strong> 10ç§’ä»¥å†…ã«æ¥ç¶šã•ã‚Œãªã„å ´åˆã¯å†è©¦è¡Œ</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="js/app.js"></script>
    <script>
        let peer = null;
        let call = null;
        let remoteStream = null;
        let frameQueue = [];
        let processor = null;
        let generator = null;
        let canvas = null;
        let ctx = null;
        let isConnected = false;
        let delayMs = 5000; // 5ç§’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        let isProcessing = false;
        let broadcastId = null;

        // PeerJSæ¥ç¶šã‚’åˆæœŸåŒ–
        function initializePeer() {
            // å—ä¿¡å´ã®ãƒ©ãƒ³ãƒ€ãƒ ãªpeerIDã‚’ç”Ÿæˆ
            const peerId = 'camera-viewer-' + Math.random().toString(36).substr(2, 9);
            
            console.log('ğŸ”„ PeerJSåˆæœŸåŒ–é–‹å§‹ (å—ä¿¡å´):', peerId);
            
            peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 2, // ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ 
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', function(id) {
                console.log('âœ… PeerJSæ¥ç¶šæˆåŠŸ (å—ä¿¡å´):', id);
                document.getElementById('peerId').textContent = id;
                document.getElementById('connectionStatus').textContent = 'æ¥ç¶šå¯èƒ½';
                
                // æ¥ç¶šæˆåŠŸã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                document.getElementById('statusText').textContent = 'å—ä¿¡æº–å‚™å®Œäº† - é…ä¿¡IDã‚’å…¥åŠ›ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„';
            });

            peer.on('call', function(incomingCall) {
                console.log('é€šè©±è¦æ±‚ã‚’å—ä¿¡');
                incomingCall.answer();
                
                incomingCall.on('stream', function(stream) {
                    console.log('ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡');
                    remoteStream = stream;
                    handleRemoteStream(stream);
                });
                
                incomingCall.on('close', function() {
                    console.log('é€šè©±çµ‚äº†');
                    disconnectFromBroadcast();
                });
                
                incomingCall.on('error', function(error) {
                    console.error('é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                    disconnectFromBroadcast();
                });
            });

            peer.on('error', function(err) {
                console.error('âŒ PeerJS ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('connectionStatus').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.type;
                
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ';
                switch (err.type) {
                    case 'network':
                        errorMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'server-error':
                        errorMessage += 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'peer-unavailable':
                        errorMessage += 'é…ä¿¡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                        break;
                    case 'browser-incompatible':
                        errorMessage += 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
                        break;
                    default:
                        errorMessage += err.type;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
                
                // è‡ªå‹•å†æ¥ç¶š
                if (err.type === 'network' || err.type === 'server-error') {
                    console.log('ğŸ”„ 5ç§’å¾Œã«è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
                    setTimeout(() => {
                        initializePeer();
                    }, 5000);
                }
            });
        }

        // é…ä¿¡IDã‚’è²¼ã‚Šä»˜ã‘
        function pasteBroadcastId() {
            navigator.clipboard.readText().then(text => {
                document.getElementById('broadcastIdInput').value = text;
            }).catch(err => {
                console.warn('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:', err);
            });
        }

        // é…ä¿¡ã«æ¥ç¶š
        function connectToBroadcast() {
            if (!peer) {
                console.error('PeerJS ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰é…ä¿¡IDã‚’å–å¾—
            const inputField = document.getElementById('broadcastIdInput');
            const inputId = inputField.value.trim();
            
            if (!inputId) {
                alert('é…ä¿¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                inputField.focus();
                return;
            }
            
            broadcastId = inputId;

            try {
                console.log('ğŸ”„ é…ä¿¡ã«æ¥ç¶šä¸­...', broadcastId);
                document.getElementById('statusText').textContent = 'é…ä¿¡ã«æ¥ç¶šä¸­...';
                
                call = peer.call(broadcastId);
                
                if (!call) {
                    throw new Error('é…ä¿¡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                console.log('ğŸ“ é€šè©±è¦æ±‚ã‚’é€ä¿¡:', broadcastId);
                
                call.on('stream', function(stream) {
                    console.log('âœ… é…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡');
                    remoteStream = stream;
                    handleRemoteStream(stream);
                    
                    document.getElementById('statusText').textContent = 'é…ä¿¡ã‚’å—ä¿¡ä¸­...';
                    document.getElementById('connectionStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    isConnected = true;
                    console.log('ğŸ¬ æ˜ åƒé…ä¿¡é–‹å§‹');
                });
                
                call.on('close', function() {
                    console.log('ğŸ“´ é…ä¿¡çµ‚äº†');
                    disconnectFromBroadcast();
                });
                
                call.on('error', function(error) {
                    console.error('âŒ é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('statusText').textContent = 'é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error.message;
                });
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’ç›£è¦–
                setTimeout(() => {
                    if (!isConnected) {
                        console.warn('âš ï¸ æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - é…ä¿¡IDã¾ãŸã¯é…ä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                        document.getElementById('statusText').textContent = 'æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - é…ä¿¡IDã¾ãŸã¯é…ä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                    }
                }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
            } catch (error) {
                console.error('âŒ é…ä¿¡ã¸ã®æ¥ç¶šã«å¤±æ•—:', error);
                document.getElementById('statusText').textContent = 'é…ä¿¡ã¸ã®æ¥ç¶šã«å¤±æ•—: ' + error.message;
            }
        }

        // é…ä¿¡ã‹ã‚‰åˆ‡æ–­
        function disconnectFromBroadcast() {
            if (call) {
                call.close();
                call = null;
            }
            
            stopDelayBuffer();
            
            const video = document.getElementById('remoteVideo');
            video.srcObject = null;
            video.src = '';
            
            document.getElementById('statusText').textContent = 'é…ä¿¡ã‚’åœæ­¢ã—ã¾ã—ãŸ';
            document.getElementById('connectionStatus').textContent = 'åˆ‡æ–­æ¸ˆã¿';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            isConnected = false;
            remoteStream = null;
        }

        // ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å‡¦ç†
        function handleRemoteStream(stream) {
            console.log('ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†é–‹å§‹, é…å»¶:', delayMs + 'ms');
            
            if (delayMs > 0) {
                startDelayBuffer(stream);
            } else {
                // é…å»¶ãªã—ã§ç›´æ¥è¡¨ç¤º
                const video = document.getElementById('remoteVideo');
                video.srcObject = stream;
                document.getElementById('delayStatus').textContent = 'ç„¡åŠ¹';
            }
        }

        // MediaStreamTrackProcessor ã‚’ä½¿ç”¨ã—ãŸé«˜æ€§èƒ½é…å»¶ãƒãƒƒãƒ•ã‚¡
        function startDelayBuffer(stream) {
            try {
                // å‰ã®å‡¦ç†ã‚’åœæ­¢
                stopDelayBuffer();
                
                const videoTrack = stream.getVideoTracks()[0];
                if (!videoTrack) {
                    console.error('ãƒ“ãƒ‡ã‚ªãƒˆãƒ©ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // MediaStreamTrackProcessor ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (typeof MediaStreamTrackProcessor === 'undefined') {
                    console.warn('MediaStreamTrackProcessor ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å¾“æ¥ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                    fallbackDelayBuffer(stream);
                    return;
                }

                processor = new MediaStreamTrackProcessor({track: videoTrack});
                const reader = processor.readable.getReader();
                
                canvas = document.getElementById('delayCanvas');
                ctx = canvas.getContext('2d');
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                frameQueue = [];
                isProcessing = true;
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ èª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ—
                async function readFrames() {
                    try {
                        while (isProcessing) {
                            const result = await reader.read();
                            if (result.done) break;
                            
                            const frame = result.value;
                            const timestamp = performance.now();
                            
                            // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                            frameQueue.push({
                                frame: frame,
                                timestamp: timestamp
                            });
                            
                            // ã‚­ãƒ¥ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’åˆ¶é™ï¼ˆãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æŠ‘åˆ¶ï¼‰
                            if (frameQueue.length > 300) { // 10ç§’åˆ†ç¨‹åº¦
                                const oldFrame = frameQueue.shift();
                                oldFrame.frame.close();
                            }
                        }
                    } catch (error) {
                        console.error('ãƒ•ãƒ¬ãƒ¼ãƒ èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                // é…å»¶æç”»ãƒ«ãƒ¼ãƒ—
                function renderDelayedFrames() {
                    if (!isProcessing) return;
                    
                    const now = performance.now();
                    const targetTime = now - delayMs;
                    
                    // é…å»¶æ™‚é–“ã«é”ã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¤œç´¢
                    const frameIndex = frameQueue.findIndex(item => item.timestamp <= targetTime);
                    
                    if (frameIndex !== -1) {
                        const frameItem = frameQueue[frameIndex];
                        const frame = frameItem.frame;
                        
                        try {
                            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
                            canvas.width = frame.displayWidth || 640;
                            canvas.height = frame.displayHeight || 360;
                            ctx.drawImage(frame, 0, 0);
                            
                            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒ“ãƒ‡ã‚ªè¦ç´ ã«è¡¨ç¤º
                            const video = document.getElementById('remoteVideo');
                            
                            // MediaSourceã‚’ä½¿ã£ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒ“ãƒ‡ã‚ªã¨ã—ã¦è¡¨ç¤º
                            canvas.toBlob(function(blob) {
                                if (blob) {
                                    const url = URL.createObjectURL(blob);
                                    
                                    // å‰ã®URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                                    if (video.src && video.src.startsWith('blob:')) {
                                        URL.revokeObjectURL(video.src);
                                    }
                                    
                                    video.src = url;
                                    video.currentTime = 0;
                                }
                            }, 'image/jpeg', 0.9);
                            
                        } catch (error) {
                            console.error('ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ã‚¨ãƒ©ãƒ¼:', error);
                        }
                        
                        // ä½¿ç”¨æ¸ˆã¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                        for (let i = 0; i <= frameIndex; i++) {
                            frameQueue[i].frame.close();
                        }
                        frameQueue.splice(0, frameIndex + 1);
                    }
                    
                    requestAnimationFrame(renderDelayedFrames);
                }
                
                // å‡¦ç†ã‚’é–‹å§‹
                readFrames();
                renderDelayedFrames();
                
                document.getElementById('delayStatus').textContent = `æœ‰åŠ¹ (${delayMs/1000}ç§’)`;
                
            } catch (error) {
                console.error('é…å»¶ãƒãƒƒãƒ•ã‚¡ã®é–‹å§‹ã«å¤±æ•—:', error);
                fallbackDelayBuffer(stream);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é…å»¶ãƒãƒƒãƒ•ã‚¡ï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
        function fallbackDelayBuffer(stream) {
            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é…å»¶ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ç”¨');
            
            const video = document.getElementById('remoteVideo');
            const canvas = document.getElementById('delayCanvas');
            const ctx = canvas.getContext('2d');
            
            // ä¸€æ™‚çš„ãªãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆ
            const tempVideo = document.createElement('video');
            tempVideo.srcObject = stream;
            tempVideo.muted = true;
            tempVideo.autoplay = true;
            tempVideo.playsinline = true;
            
            let frameBuffer = [];
            isProcessing = true;
            
            tempVideo.addEventListener('loadedmetadata', function() {
                canvas.width = tempVideo.videoWidth || 640;
                canvas.height = tempVideo.videoHeight || 360;
                
                function captureFrame() {
                    if (!isProcessing) return;
                    
                    if (tempVideo.readyState >= 2) {
                        ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        frameBuffer.push({
                            data: imageData,
                            timestamp: performance.now()
                        });
                        
                        // ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºåˆ¶é™
                        if (frameBuffer.length > 300) {
                            frameBuffer.shift();
                        }
                        
                        // é…å»¶ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
                        const now = performance.now();
                        const targetTime = now - delayMs;
                        const frameToShow = frameBuffer.find(frame => frame.timestamp <= targetTime);
                        
                        if (frameToShow) {
                            ctx.putImageData(frameToShow.data, 0, 0);
                            frameBuffer = frameBuffer.filter(frame => frame.timestamp > targetTime);
                        }
                    }
                    
                    setTimeout(captureFrame, 33); // ç´„30fps
                }
                
                captureFrame();
            });
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒ“ãƒ‡ã‚ªè¦ç´ ã¨ã—ã¦è¡¨ç¤º
            const canvasStream = canvas.captureStream(30);
            video.srcObject = canvasStream;
            
            document.getElementById('delayStatus').textContent = `æœ‰åŠ¹ (${delayMs/1000}ç§’) - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯`;
        }

        // é…å»¶ãƒãƒƒãƒ•ã‚¡ã‚’åœæ­¢
        function stopDelayBuffer() {
            isProcessing = false;
            
            if (processor) {
                try {
                    processor.readable.cancel();
                } catch (e) {
                    console.warn('Processoråœæ­¢ã‚¨ãƒ©ãƒ¼:', e);
                }
                processor = null;
            }
            
            if (generator) {
                try {
                    generator.close();
                } catch (e) {
                    console.warn('Generatoråœæ­¢ã‚¨ãƒ©ãƒ¼:', e);
                }
                generator = null;
            }
            
            // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            frameQueue.forEach(item => {
                if (item.frame && item.frame.close) {
                    item.frame.close();
                }
            });
            frameQueue = [];
        }

        // å—ä¿¡çµ±è¨ˆã‚’æ›´æ–°
        function updateReceiveStats() {
            if (!call || !call.peerConnection) return;
            
            call.peerConnection.getStats().then(stats => {
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                        const bitrate = Math.round((report.bytesReceived * 8) / 1000); // kbps
                        const fps = report.framesPerSecond || 0;
                        const packetsLost = report.packetsLost || 0;
                        const packetsReceived = report.packetsReceived || 1;
                        const lossPercentage = ((packetsLost / (packetsLost + packetsReceived)) * 100).toFixed(2);
                        
                        document.getElementById('receiveBitrateStats').textContent = bitrate + ' kbps';
                        document.getElementById('receiveFpsStats').textContent = fps + ' fps';
                        document.getElementById('packetLossStats').textContent = lossPercentage + ' %';
                    }
                });
            }).catch(err => {
                console.warn('å—ä¿¡çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            });
            
            // ãƒãƒƒãƒ•ã‚¡çŠ¶æ…‹ã‚’æ›´æ–°
            const bufferLength = frameQueue.length;
            const bufferTimeMs = bufferLength > 0 ? 
                (performance.now() - frameQueue[0].timestamp) : 0;
            document.getElementById('bufferStatus').textContent = 
                `${bufferLength}ãƒ•ãƒ¬ãƒ¼ãƒ  (${Math.round(bufferTimeMs)}ms)`;
        }

        // é…å»¶æ™‚é–“ã‚’æ›´æ–°
        function updateDelayTime() {
            const slider = document.getElementById('delaySlider');
            delayMs = parseInt(slider.value) * 1000; // ç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
            document.getElementById('delayValue').textContent = (delayMs/1000) + 'ç§’';
            
            console.log('é…å»¶æ™‚é–“æ›´æ–°:', delayMs + 'ms');
            
            // æ¥ç¶šä¸­ã®å ´åˆã¯é…å»¶è¨­å®šã‚’å†é©ç”¨
            if (isConnected && remoteStream) {
                handleRemoteStream(remoteStream);
            }
        }

        // å…¨ç”»é¢è¡¨ç¤º
        function toggleFullscreen() {
            const video = document.getElementById('remoteVideo');
            
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.error('ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«å¤±æ•—:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            disconnectFromBroadcast();
            if (peer) {
                peer.destroy();
            }
            window.location.href = 'index.html';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePeer();
            
            // Canvasè¦ç´ ã‚’æº–å‚™
            canvas = document.getElementById('delayCanvas');
            ctx = canvas.getContext('2d');
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('connectBtn').addEventListener('click', connectToBroadcast);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectFromBroadcast);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('delaySlider').addEventListener('input', updateDelayTime);
            document.getElementById('pasteIdBtn').addEventListener('click', pasteBroadcastId);
            
            // Enterã‚­ãƒ¼ã§ã‚‚æ¥ç¶š
            document.getElementById('broadcastIdInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    connectToBroadcast();
                }
            });
            
            // åˆæœŸé…å»¶å€¤ã‚’è¨­å®š
            updateDelayTime();
            
            // å®šæœŸçš„ã«çµ±è¨ˆã‚’æ›´æ–°
            setInterval(updateReceiveStats, 1000);
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ã‚’è¡¨ç¤º
            const supportStatus = typeof MediaStreamTrackProcessor !== 'undefined' 
                ? 'ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿ (é«˜æ€§èƒ½)' 
                : 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ãƒ¢ãƒ¼ãƒ‰';
            console.log('MediaStreamTrackProcessor:', supportStatus);
            document.getElementById('statusText').textContent = 'MediaStreamTrackProcessor: ' + supportStatus;
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            disconnectFromBroadcast();
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html> 