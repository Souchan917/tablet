<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©æ˜ åƒ - è¬è§£ãã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
    
    <div class="container">
        <h1>ã‚«ãƒ¡ãƒ©æ˜ åƒ</h1>
        
        <div class="camera-container">
            <div class="video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <canvas id="delayCanvas" style="display: none;"></canvas>
                <p id="statusText">é…ä¿¡ã«æ¥ç¶šä¸­...</p>
            </div>
            
            <div class="delay-controls">
                <label for="delaySlider">é…å»¶æ™‚é–“:</label>
                <input type="range" id="delaySlider" min="0" max="30" value="5" step="1" class="delay-slider">
                <span id="delayValue">5ç§’</span>
            </div>
            
            <div class="broadcast-id-input">
                <p style="color: #9AFF9A; font-size: 14px; margin: 10px 0;">
                    ğŸš€ ç°¡å˜æ¥ç¶šãƒ¢ãƒ¼ãƒ‰ - é…ä¿¡å´ã®é–‹å§‹ã‚’å¾…æ©Ÿä¸­...
                </p>
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn" id="connectBtn">ğŸ“ æ‰‹å‹•æ¥ç¶š</button>
                <button class="camera-btn" id="disconnectBtn" disabled>âŒ åˆ‡æ–­</button>
                <button class="camera-btn" id="lowLatencyBtn">ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰</button>
                <button class="camera-btn" id="fullscreenBtn">ğŸ–¥ï¸ å…¨ç”»é¢è¡¨ç¤º</button>
            </div>
            
            <div class="connection-info">
                <h3>æ¥ç¶šæƒ…å ±</h3>
                <p>å—ä¿¡ID: <span id="peerId">æº–å‚™ä¸­...</span></p>
                <p>æ¥ç¶šçŠ¶æ…‹: <span id="connectionStatus">æº–å‚™ä¸­</span></p>
                <p>é…å»¶çŠ¶æ…‹: <span id="delayStatus">ç„¡åŠ¹</span></p>
                <p>ãƒãƒƒãƒ•ã‚¡çŠ¶æ…‹: <span id="bufferStatus">---</span></p>
            </div>
            
            <div class="receive-stats">
                <h3>å—ä¿¡çµ±è¨ˆ</h3>
                <p>å—ä¿¡ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ: <span id="receiveBitrateStats">--- kbps</span></p>
                <p>å—ä¿¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: <span id="receiveFpsStats">--- fps</span></p>
                <p>ãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚¹: <span id="packetLossStats">--- %</span></p>
            </div>
            
            <div class="troubleshooting">
                <h3>âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
                <ul>
                    <li><strong>é…ä¿¡ID:</strong> é…ä¿¡å´ã‹ã‚‰æ­£ã—ã„IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘</li>
                    <li><strong>æ¥ç¶šé †åº:</strong> é…ä¿¡å´ã‚’å…ˆã«é–‹å§‹ã—ã¦ã‹ã‚‰å—ä¿¡å´ã‚’æ¥ç¶š</li>
                    <li><strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:</strong> åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±</li>
                    <li><strong>ãƒ‡ãƒãƒƒã‚°:</strong> é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª</li>
                    <li><strong>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:</strong> 10ç§’ä»¥å†…ã«æ¥ç¶šã•ã‚Œãªã„å ´åˆã¯å†è©¦è¡Œ</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="js/app.js"></script>
    <script>
        let peer = null;
        let call = null;
        let remoteStream = null;
        let frameQueue = [];
        let processor = null;
        let generator = null;
        let canvas = null;
        let ctx = null;
        let isConnected = false;
        let delayMs = 5000; // 5ç§’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        let isProcessing = false;

        // å—ä¿¡å´ã®å›ºå®šIDï¼ˆç°¡å˜æ¥ç¶šç”¨ï¼‰
        const peerId = 'tablet-viewer-fixed';
        const broadcastId = 'tablet-broadcast-fixed'; // é…ä¿¡å´ã®å›ºå®šID

        // PeerJSæ¥ç¶šã‚’åˆæœŸåŒ–
        function initializePeer() {
            console.log('ğŸ”„ PeerJSåˆæœŸåŒ–é–‹å§‹ (å—ä¿¡å´):', peerId);
            
            // ä½é…å»¶æœ€é©åŒ–ã•ã‚ŒãŸPeerJSè¨­å®š
            peer = new Peer(peerId, {
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ],
                    iceTransportPolicy: 'all',
                    bundlePolicy: 'max-compat',
                    rtcpMuxPolicy: 'require',
                    iceCandidatePoolSize: 10
                }
            });

            peer.on('open', function(id) {
                console.log('âœ… PeerJSæ¥ç¶šæˆåŠŸ (å—ä¿¡å´):', id);
                document.getElementById('peerId').textContent = id;
                document.getElementById('connectionStatus').textContent = 'æ¥ç¶šå¯èƒ½';
                
                // æ¥ç¶šæˆåŠŸã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                document.getElementById('statusText').textContent = 'å—ä¿¡æº–å‚™å®Œäº† - è‡ªå‹•æ¥ç¶šå¯¾å¿œ';
                
                // è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œ
                setTimeout(() => {
                    tryAutoConnect();
                }, 2000); // 2ç§’å¾Œã«è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œ
            });

            peer.on('call', function(incomingCall) {
                console.log('é€šè©±è¦æ±‚ã‚’å—ä¿¡');
                incomingCall.answer();
                
                incomingCall.on('stream', function(stream) {
                    console.log('ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡');
                    remoteStream = stream;
                    handleRemoteStream(stream);
                });
                
                incomingCall.on('close', function() {
                    console.log('é€šè©±çµ‚äº†');
                    disconnectFromBroadcast();
                });
                
                incomingCall.on('error', function(error) {
                    console.error('é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                    disconnectFromBroadcast();
                });
            });

            peer.on('error', function(err) {
                console.error('âŒ PeerJS ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('connectionStatus').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.type;
                
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ';
                switch (err.type) {
                    case 'network':
                        errorMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'server-error':
                        errorMessage += 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'peer-unavailable':
                        errorMessage += 'é…ä¿¡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                        break;
                    case 'browser-incompatible':
                        errorMessage += 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
                        break;
                    default:
                        errorMessage += err.type;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
                
                // è‡ªå‹•å†æ¥ç¶š
                if (err.type === 'network' || err.type === 'server-error') {
                    console.log('ğŸ”„ 5ç§’å¾Œã«è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
                    setTimeout(() => {
                        initializePeer();
                    }, 5000);
                }
            });
        }

        // è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œ
        async function tryAutoConnect() {
            if (!peer || !peer.open) {
                console.log('âš ï¸ PeerJSæ¥ç¶šãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                console.log('ğŸ”„ è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œä¸­...', broadcastId);
                document.getElementById('statusText').textContent = 'é…ä¿¡ã‚’æ¤œç´¢ä¸­...';
                
                // é…ä¿¡ã®å­˜åœ¨ã‚’ç¢ºèª
                await checkBroadcastExists(broadcastId);
                
                console.log('ğŸ“ é…ä¿¡ã«è‡ªå‹•æ¥ç¶šä¸­...', broadcastId);
                document.getElementById('statusText').textContent = 'é…ä¿¡ã«è‡ªå‹•æ¥ç¶šä¸­...';
                
                // å®Ÿéš›ã®é€šè©±ã‚’é–‹å§‹
                call = peer.call(broadcastId);
                
                if (!call) {
                    throw new Error('é€šè©±ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('ğŸ“ é€šè©±è¦æ±‚ã‚’é€ä¿¡:', broadcastId);
                
                call.on('stream', function(stream) {
                    console.log('âœ… é…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡');
                    remoteStream = stream;
                    
                    // å—ä¿¡å´ã®ä½é…å»¶è¨­å®š
                    try {
                        const pc = call.peerConnection;
                        
                        // å—ä¿¡è€…ã®ä½é…å»¶è¨­å®š
                        const receivers = pc.getReceivers();
                        receivers.forEach(receiver => {
                            if (receiver.track && receiver.track.kind === 'video') {
                                console.log('ğŸ¯ ãƒ“ãƒ‡ã‚ªå—ä¿¡è€…ã®ä½é…å»¶è¨­å®š');
                                
                                // ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼ã®è¨­å®š
                                const transceiver = pc.getTransceivers().find(t => t.receiver === receiver);
                                if (transceiver) {
                                    transceiver.direction = 'recvonly';
                                    console.log('âœ… å—ä¿¡å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
                                }
                            }
                        });
                        
                        // çµ±è¨ˆæƒ…å ±ã®ç›£è¦–
                        const statsInterval = setInterval(() => {
                            if (!isConnected) {
                                clearInterval(statsInterval);
                                return;
                            }
                            
                            pc.getStats().then(stats => {
                                stats.forEach(report => {
                                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                        console.log('ğŸ“Š å—ä¿¡çµ±è¨ˆ:', {
                                            bitrate: Math.round(report.bytesReceived * 8 / 1000),
                                            fps: report.framesPerSecond,
                                            packetsLost: report.packetsLost,
                                            jitter: report.jitter
                                        });
                                    }
                                });
                            }).catch(e => console.warn('âš ï¸ çµ±è¨ˆå–å¾—å¤±æ•—:', e));
                        }, 5000); // 5ç§’ã”ã¨ã«çµ±è¨ˆè¡¨ç¤º
                        
                    } catch (error) {
                        console.warn('âš ï¸ å—ä¿¡å´ä½é…å»¶è¨­å®šã®ä¸€éƒ¨ãŒå¤±æ•—:', error);
                    }
                    
                    handleRemoteStream(stream);
                    
                    document.getElementById('statusText').textContent = 'é…ä¿¡ã‚’å—ä¿¡ä¸­...';
                    document.getElementById('connectionStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    isConnected = true;
                    console.log('ğŸ¬ ä½é…å»¶æ˜ åƒé…ä¿¡é–‹å§‹');
                });
                
                call.on('close', function() {
                    console.log('ğŸ“´ é…ä¿¡çµ‚äº†');
                    disconnectFromBroadcast();
                });
                
                call.on('error', function(error) {
                    console.error('âŒ é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('statusText').textContent = 'é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error.message;
                });
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’ç›£è¦–
                setTimeout(() => {
                    if (!isConnected) {
                        console.warn('âš ï¸ æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                        document.getElementById('statusText').textContent = 'é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - é…ä¿¡å´ã®é–‹å§‹ã‚’å¾…æ©Ÿä¸­...';
                        
                        // è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œ
                        setTimeout(() => {
                            if (!isConnected) {
                                tryAutoConnect();
                            }
                        }, 5000);
                    }
                }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
            } catch (error) {
                console.error('âŒ è‡ªå‹•æ¥ç¶šã«å¤±æ•—:', error);
                document.getElementById('statusText').textContent = 'é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - é…ä¿¡å´ã®é–‹å§‹ã‚’å¾…æ©Ÿä¸­...';
                
                // è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œ
                setTimeout(() => {
                    if (!isConnected) {
                        tryAutoConnect();
                    }
                }, 5000);
            }
        }

        // æ‰‹å‹•æ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰
        async function connectToBroadcast() {
            if (!peer) {
                console.error('âŒ PeerJS ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                document.getElementById('statusText').textContent = 'PeerJSãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                return;
            }

            if (!peer.open) {
                console.error('âŒ PeerJSæ¥ç¶šãŒé–‹ã„ã¦ã„ã¾ã›ã‚“');
                document.getElementById('statusText').textContent = 'PeerJSæ¥ç¶šãŒé–‹ã„ã¦ã„ã¾ã›ã‚“';
                return;
            }

            try {
                console.log('ğŸ“ æ‰‹å‹•æ¥ç¶šã‚’è©¦è¡Œ...', broadcastId);
                document.getElementById('statusText').textContent = 'æ‰‹å‹•æ¥ç¶šä¸­...';
                
                // é…ä¿¡ã®å­˜åœ¨ã‚’ç¢ºèª
                await checkBroadcastExists(broadcastId);
                
                console.log('ğŸ“ é…ä¿¡ã«æ¥ç¶šä¸­...', broadcastId);
                document.getElementById('statusText').textContent = 'é…ä¿¡ã«æ¥ç¶šä¸­...';
                
                // å®Ÿéš›ã®é€šè©±ã‚’é–‹å§‹
                call = peer.call(broadcastId);
                
                if (!call) {
                    throw new Error('é€šè©±ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('ğŸ“ é€šè©±è¦æ±‚ã‚’é€ä¿¡:', broadcastId);
                
                call.on('stream', function(stream) {
                    console.log('âœ… é…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡');
                    remoteStream = stream;
                    
                    // å—ä¿¡å´ã®ä½é…å»¶è¨­å®š
                    try {
                        const pc = call.peerConnection;
                        
                        // å—ä¿¡è€…ã®ä½é…å»¶è¨­å®š
                        const receivers = pc.getReceivers();
                        receivers.forEach(receiver => {
                            if (receiver.track && receiver.track.kind === 'video') {
                                console.log('ğŸ¯ ãƒ“ãƒ‡ã‚ªå—ä¿¡è€…ã®ä½é…å»¶è¨­å®š');
                                
                                // ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼ã®è¨­å®š
                                const transceiver = pc.getTransceivers().find(t => t.receiver === receiver);
                                if (transceiver) {
                                    transceiver.direction = 'recvonly';
                                    console.log('âœ… å—ä¿¡å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
                                }
                            }
                        });
                        
                        // çµ±è¨ˆæƒ…å ±ã®ç›£è¦–
                        const statsInterval = setInterval(() => {
                            if (!isConnected) {
                                clearInterval(statsInterval);
                                return;
                            }
                            
                            pc.getStats().then(stats => {
                                stats.forEach(report => {
                                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                        console.log('ğŸ“Š å—ä¿¡çµ±è¨ˆ:', {
                                            bitrate: Math.round(report.bytesReceived * 8 / 1000),
                                            fps: report.framesPerSecond,
                                            packetsLost: report.packetsLost,
                                            jitter: report.jitter
                                        });
                                    }
                                });
                            }).catch(e => console.warn('âš ï¸ çµ±è¨ˆå–å¾—å¤±æ•—:', e));
                        }, 5000); // 5ç§’ã”ã¨ã«çµ±è¨ˆè¡¨ç¤º
                        
                    } catch (error) {
                        console.warn('âš ï¸ å—ä¿¡å´ä½é…å»¶è¨­å®šã®ä¸€éƒ¨ãŒå¤±æ•—:', error);
                    }
                    
                    handleRemoteStream(stream);
                    
                    document.getElementById('statusText').textContent = 'é…ä¿¡ã‚’å—ä¿¡ä¸­...';
                    document.getElementById('connectionStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    isConnected = true;
                    console.log('ğŸ¬ ä½é…å»¶æ˜ åƒé…ä¿¡é–‹å§‹');
                });
                
                call.on('close', function() {
                    console.log('ğŸ“´ é…ä¿¡çµ‚äº†');
                    disconnectFromBroadcast();
                });
                
                call.on('error', function(error) {
                    console.error('âŒ é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('statusText').textContent = 'é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error.message;
                });
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’ç›£è¦–
                setTimeout(() => {
                    if (!isConnected) {
                        console.warn('âš ï¸ æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                        document.getElementById('statusText').textContent = 'æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - é…ä¿¡å´ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                    }
                }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
            } catch (error) {
                console.error('âŒ é…ä¿¡ã¸ã®æ¥ç¶šã«å¤±æ•—:', error);
                let errorMessage = 'é…ä¿¡ã¸ã®æ¥ç¶šã«å¤±æ•—: ';
                
                if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                    errorMessage += 'é…ä¿¡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (error.message.includes('ç¢ºèªå¤±æ•—')) {
                    errorMessage += 'é…ä¿¡ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
            }
        }

        // é…ä¿¡ã®å­˜åœ¨ã‚’ç¢ºèª
        function checkBroadcastExists(broadcastId) {
            return new Promise((resolve, reject) => {
                // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚’è©¦è¡Œã—ã¦é…ä¿¡ã®å­˜åœ¨ã‚’ç¢ºèª
                const testConnection = peer.connect(broadcastId);
                
                testConnection.on('open', function() {
                    console.log('âœ… é…ä¿¡IDç¢ºèªæ¸ˆã¿:', broadcastId);
                    testConnection.close();
                    resolve(true);
                });
                
                testConnection.on('error', function(error) {
                    console.warn('âŒ é…ä¿¡IDç¢ºèªå¤±æ•—:', error);
                    reject(error);
                });
                
                // 5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                setTimeout(() => {
                    testConnection.close();
                    reject(new Error('é…ä¿¡IDç¢ºèªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
                }, 5000);
            });
        }

        // é…ä¿¡ã‹ã‚‰åˆ‡æ–­
        function disconnectFromBroadcast() {
            if (call) {
                call.close();
                call = null;
            }
            
            stopDelayBuffer();
            
            const video = document.getElementById('remoteVideo');
            video.srcObject = null;
            video.src = '';
            
            document.getElementById('statusText').textContent = 'é…ä¿¡ã‚’åœæ­¢ã—ã¾ã—ãŸ';
            document.getElementById('connectionStatus').textContent = 'åˆ‡æ–­æ¸ˆã¿';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            isConnected = false;
            remoteStream = null;
        }

        // ä½é…å»¶æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†
        function handleRemoteStream(stream) {
            console.log('ğŸ¬ ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†é–‹å§‹, é…å»¶:', delayMs + 'ms');
            
            if (delayMs > 0) {
                startDelayBuffer(stream);
            } else {
                // ğŸš€ ã‚¼ãƒ­é…å»¶ãƒ¢ãƒ¼ãƒ‰ - æœ€é«˜æ€§èƒ½ã®ç›´æ¥è¡¨ç¤º
                console.log('ğŸš€ ã‚¼ãƒ­é…å»¶ãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
                const video = document.getElementById('remoteVideo');
                
                // ä½é…å»¶ã®ãŸã‚ã®æœ€é©åŒ–è¨­å®š
                video.srcObject = stream;
                video.muted = true; // ã‚¨ã‚³ãƒ¼é˜²æ­¢
                video.autoplay = true;
                video.playsInline = true;
                video.setAttribute('playsinline', 'true');
                
                // GPUåŠ é€Ÿã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
                if (video.style) {
                    video.style.transform = 'translateZ(0)';
                    video.style.willChange = 'transform';
                    video.style.backfaceVisibility = 'hidden';
                }
                
                // ä½é…å»¶å†ç”Ÿè¨­å®š
                video.play().then(() => {
                    console.log('âœ… ã‚¼ãƒ­é…å»¶å†ç”Ÿé–‹å§‹');
                    document.getElementById('delayStatus').textContent = 'ç„¡åŠ¹ï¼ˆã‚¼ãƒ­é…å»¶ï¼‰';
                }).catch(error => {
                    console.error('âŒ ã‚¼ãƒ­é…å»¶å†ç”Ÿå¤±æ•—:', error);
                    document.getElementById('delayStatus').textContent = 'ç„¡åŠ¹ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰';
                });
            }
        }

        // é«˜æ€§èƒ½æœ€é©åŒ–ã•ã‚ŒãŸé…å»¶ãƒãƒƒãƒ•ã‚¡
        function startDelayBuffer(stream) {
            try {
                console.log('ğŸï¸ é«˜æ€§èƒ½é…å»¶ãƒãƒƒãƒ•ã‚¡é–‹å§‹:', delayMs + 'ms');
                
                // å‰ã®å‡¦ç†ã‚’åœæ­¢
                stopDelayBuffer();
                
                const videoTrack = stream.getVideoTracks()[0];
                if (!videoTrack) {
                    console.error('âŒ ãƒ“ãƒ‡ã‚ªãƒˆãƒ©ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // MediaStreamTrackProcessor ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (typeof MediaStreamTrackProcessor === 'undefined') {
                    console.warn('âš ï¸ MediaStreamTrackProcessor ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                    fallbackDelayBuffer(stream);
                    return;
                }

                processor = new MediaStreamTrackProcessor({track: videoTrack});
                const reader = processor.readable.getReader();
                
                canvas = document.getElementById('delayCanvas');
                ctx = canvas.getContext('2d');
                
                // GPUåŠ é€Ÿã®ãŸã‚ã®2D contextè¨­å®š
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                frameQueue = [];
                isProcessing = true;
                
                let frameCount = 0;
                let lastStatsTime = performance.now();
                
                // ãƒ•ãƒ¬ãƒ¼ãƒ èª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ—ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
                async function readFrames() {
                    try {
                        while (isProcessing) {
                            const result = await reader.read();
                            if (result.done) break;
                            
                            const frame = result.value;
                            const timestamp = performance.now();
                            
                            frameCount++;
                            
                            // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
                            frameQueue.push({
                                frame: frame,
                                timestamp: timestamp
                            });
                            
                            // å‹•çš„ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã«å¿œã˜ã¦èª¿æ•´ï¼‰
                            const maxFrames = Math.min(300, (delayMs / 16.67) * 1.5); // 1.5å€ã®ãƒãƒƒãƒ•ã‚¡
                            if (frameQueue.length > maxFrames) {
                                const oldFrame = frameQueue.shift();
                                oldFrame.frame.close();
                            }
                            
                            // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
                            if (timestamp - lastStatsTime >= 1000) {
                                const fps = Math.round((frameCount * 1000) / (timestamp - lastStatsTime));
                                console.log('ğŸ“Š ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†çµ±è¨ˆ:', {
                                    fps: fps,
                                    queueSize: frameQueue.length,
                                    maxFrames: maxFrames
                                });
                                frameCount = 0;
                                lastStatsTime = timestamp;
                            }
                        }
                    } catch (error) {
                        console.error('âŒ ãƒ•ãƒ¬ãƒ¼ãƒ èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                // é«˜é€Ÿé…å»¶æç”»ãƒ«ãƒ¼ãƒ—
                function renderDelayedFrames() {
                    if (!isProcessing) return;
                    
                    const now = performance.now();
                    const targetTime = now - delayMs;
                    
                    // æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ æ¤œç´¢ï¼ˆç·šå½¢æ¤œç´¢ã‚’æ”¹å–„ï¼‰
                    let frameIndex = -1;
                    for (let i = frameQueue.length - 1; i >= 0; i--) {
                        if (frameQueue[i].timestamp <= targetTime) {
                            frameIndex = i;
                            break;
                        }
                    }
                    
                    if (frameIndex !== -1) {
                        const frameItem = frameQueue[frameIndex];
                        const frame = frameItem.frame;
                        
                        try {
                            // é«˜å“è³ªãƒ•ãƒ¬ãƒ¼ãƒ æç”»
                            const frameWidth = frame.displayWidth || frame.codedWidth || 640;
                            const frameHeight = frame.displayHeight || frame.codedHeight || 360;
                            
                            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã®å‹•çš„èª¿æ•´
                            if (canvas.width !== frameWidth || canvas.height !== frameHeight) {
                                canvas.width = frameWidth;
                                canvas.height = frameHeight;
                                console.log('ğŸ¨ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´:', frameWidth + 'x' + frameHeight);
                            }
                            
                            // GPUåŠ é€Ÿæç”»
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(frame, 0, 0);
                            
                            // æœ€é©åŒ–ã•ã‚ŒãŸãƒ“ãƒ‡ã‚ªè¡¨ç¤º
                            const video = document.getElementById('remoteVideo');
                            
                            // MediaStreamçµŒç”±ã§ã®ã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤ºï¼ˆã‚ˆã‚ŠåŠ¹ç‡çš„ï¼‰
                            if (canvas.captureStream) {
                                const canvasStream = canvas.captureStream(60); // 60fps
                                if (video.srcObject !== canvasStream) {
                                    video.srcObject = canvasStream;
                                    video.muted = true;
                                    video.autoplay = true;
                                    video.playsInline = true;
                                    video.play().catch(e => console.warn('âš ï¸ å†ç”Ÿé–‹å§‹å¤±æ•—:', e));
                                }
                            } else {
                                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Blobä½¿ç”¨
                                canvas.toBlob(function(blob) {
                                    if (blob && isProcessing) {
                                        const url = URL.createObjectURL(blob);
                                        
                                        // å‰ã®URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                                        if (video.src && video.src.startsWith('blob:')) {
                                            URL.revokeObjectURL(video.src);
                                        }
                                        
                                        video.src = url;
                                        video.currentTime = 0;
                                    }
                                }, 'image/jpeg', 0.95);
                            }
                            
                        } catch (error) {
                            console.error('âŒ ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ã‚¨ãƒ©ãƒ¼:', error);
                        }
                        
                        // åŠ¹ç‡çš„ãªãƒ•ãƒ¬ãƒ¼ãƒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                        for (let i = 0; i <= frameIndex; i++) {
                            frameQueue[i].frame.close();
                        }
                        frameQueue.splice(0, frameIndex + 1);
                    }
                    
                    requestAnimationFrame(renderDelayedFrames);
                }
                
                // å‡¦ç†ã‚’é–‹å§‹
                readFrames();
                renderDelayedFrames();
                
                document.getElementById('delayStatus').textContent = `æœ‰åŠ¹ (${delayMs/1000}ç§’, é«˜æ€§èƒ½)`;
                console.log('âœ… é«˜æ€§èƒ½é…å»¶ãƒãƒƒãƒ•ã‚¡é–‹å§‹å®Œäº†');
                
            } catch (error) {
                console.error('âŒ é«˜æ€§èƒ½é…å»¶ãƒãƒƒãƒ•ã‚¡ã®é–‹å§‹ã«å¤±æ•—:', error);
                fallbackDelayBuffer(stream);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é…å»¶ãƒãƒƒãƒ•ã‚¡ï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰
        function fallbackDelayBuffer(stream) {
            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é…å»¶ãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ç”¨');
            
            const video = document.getElementById('remoteVideo');
            const canvas = document.getElementById('delayCanvas');
            const ctx = canvas.getContext('2d');
            
            // ä¸€æ™‚çš„ãªãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’ä½œæˆ
            const tempVideo = document.createElement('video');
            tempVideo.srcObject = stream;
            tempVideo.muted = true;
            tempVideo.autoplay = true;
            tempVideo.playsinline = true;
            
            let frameBuffer = [];
            isProcessing = true;
            
            tempVideo.addEventListener('loadedmetadata', function() {
                canvas.width = tempVideo.videoWidth || 640;
                canvas.height = tempVideo.videoHeight || 360;
                
                function captureFrame() {
                    if (!isProcessing) return;
                    
                    if (tempVideo.readyState >= 2) {
                        ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        frameBuffer.push({
                            data: imageData,
                            timestamp: performance.now()
                        });
                        
                        // ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºåˆ¶é™
                        if (frameBuffer.length > 300) {
                            frameBuffer.shift();
                        }
                        
                        // é…å»¶ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¡¨ç¤º
                        const now = performance.now();
                        const targetTime = now - delayMs;
                        const frameToShow = frameBuffer.find(frame => frame.timestamp <= targetTime);
                        
                        if (frameToShow) {
                            ctx.putImageData(frameToShow.data, 0, 0);
                            frameBuffer = frameBuffer.filter(frame => frame.timestamp > targetTime);
                        }
                    }
                    
                    setTimeout(captureFrame, 33); // ç´„30fps
                }
                
                captureFrame();
            });
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒ“ãƒ‡ã‚ªè¦ç´ ã¨ã—ã¦è¡¨ç¤º
            const canvasStream = canvas.captureStream(30);
            video.srcObject = canvasStream;
            
            document.getElementById('delayStatus').textContent = `æœ‰åŠ¹ (${delayMs/1000}ç§’) - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯`;
        }

        // é…å»¶ãƒãƒƒãƒ•ã‚¡ã‚’åœæ­¢
        function stopDelayBuffer() {
            isProcessing = false;
            
            if (processor) {
                try {
                    processor.readable.cancel();
                } catch (e) {
                    console.warn('Processoråœæ­¢ã‚¨ãƒ©ãƒ¼:', e);
                }
                processor = null;
            }
            
            if (generator) {
                try {
                    generator.close();
                } catch (e) {
                    console.warn('Generatoråœæ­¢ã‚¨ãƒ©ãƒ¼:', e);
                }
                generator = null;
            }
            
            // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            frameQueue.forEach(item => {
                if (item.frame && item.frame.close) {
                    item.frame.close();
                }
            });
            frameQueue = [];
        }

        // å—ä¿¡çµ±è¨ˆã‚’æ›´æ–°
        function updateReceiveStats() {
            if (!call || !call.peerConnection) return;
            
            call.peerConnection.getStats().then(stats => {
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                        const bitrate = Math.round((report.bytesReceived * 8) / 1000); // kbps
                        const fps = report.framesPerSecond || 0;
                        const packetsLost = report.packetsLost || 0;
                        const packetsReceived = report.packetsReceived || 1;
                        const lossPercentage = ((packetsLost / (packetsLost + packetsReceived)) * 100).toFixed(2);
                        
                        document.getElementById('receiveBitrateStats').textContent = bitrate + ' kbps';
                        document.getElementById('receiveFpsStats').textContent = fps + ' fps';
                        document.getElementById('packetLossStats').textContent = lossPercentage + ' %';
                    }
                });
            }).catch(err => {
                console.warn('å—ä¿¡çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            });
            
            // ãƒãƒƒãƒ•ã‚¡çŠ¶æ…‹ã‚’æ›´æ–°
            const bufferLength = frameQueue.length;
            const bufferTimeMs = bufferLength > 0 ? 
                (performance.now() - frameQueue[0].timestamp) : 0;
            document.getElementById('bufferStatus').textContent = 
                `${bufferLength}ãƒ•ãƒ¬ãƒ¼ãƒ  (${Math.round(bufferTimeMs)}ms)`;
        }

        // é…å»¶æ™‚é–“ã‚’æ›´æ–°
        function updateDelayTime() {
            const slider = document.getElementById('delaySlider');
            delayMs = parseInt(slider.value) * 1000; // ç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
            document.getElementById('delayValue').textContent = (delayMs/1000) + 'ç§’';
            
            console.log('é…å»¶æ™‚é–“æ›´æ–°:', delayMs + 'ms');
            
            // æ¥ç¶šä¸­ã®å ´åˆã¯é…å»¶è¨­å®šã‚’å†é©ç”¨
            if (isConnected && remoteStream) {
                handleRemoteStream(remoteStream);
            }
        }

        // å…¨ç”»é¢è¡¨ç¤º
        function toggleFullscreen() {
            const video = document.getElementById('remoteVideo');
            
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.error('ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«å¤±æ•—:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            const inputField = document.getElementById('broadcastIdInput');
            const inputId = inputField.value.trim();
            
            if (!inputId) {
                alert('é…ä¿¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                inputField.focus();
                return;
            }
            
            if (!peer || !peer.open) {
                document.getElementById('statusText').textContent = 'PeerJSæ¥ç¶šã‚’ç¢ºèªä¸­...';
                console.log('âŒ PeerJSæ¥ç¶šãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                console.log('ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹:', inputId);
                document.getElementById('statusText').textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
                
                await checkBroadcastExists(inputId);
                
                console.log('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
                document.getElementById('statusText').textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ - é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ';
                
            } catch (error) {
                console.error('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
                document.getElementById('statusText').textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•— - é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            }
        }

        // ä½é…å»¶ãƒ†ã‚¹ãƒˆ
        async function testLowLatency() {
            const inputField = document.getElementById('broadcastIdInput');
            const inputId = inputField.value.trim();
            
            if (!inputId) {
                alert('é…ä¿¡IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                inputField.focus();
                return;
            }
            
            if (!peer || !peer.open) {
                document.getElementById('statusText').textContent = 'PeerJSæ¥ç¶šã‚’ç¢ºèªä¸­...';
                console.log('âŒ PeerJSæ¥ç¶šãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                console.log('ğŸš€ ä½é…å»¶ãƒ†ã‚¹ãƒˆé–‹å§‹:', inputId);
                document.getElementById('statusText').textContent = 'ä½é…å»¶ãƒ†ã‚¹ãƒˆä¸­...';
                
                // é…å»¶ã‚’0ç§’ã«è¨­å®š
                const delaySlider = document.getElementById('delaySlider');
                delaySlider.value = 0;
                updateDelayTime();
                
                // é…ä¿¡ç¢ºèª
                await checkBroadcastExists(inputId);
                
                // ä¸€æ™‚çš„ã«åˆ‡æ–­
                if (isConnected) {
                    disconnectFromBroadcast();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                console.log('ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã§æ¥ç¶šä¸­...', inputId);
                document.getElementById('statusText').textContent = 'ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã§æ¥ç¶šä¸­...';
                
                broadcastId = inputId;
                
                // ä½é…å»¶æ¥ç¶šã‚’é–‹å§‹
                call = peer.call(broadcastId);
                
                if (!call) {
                    throw new Error('ä½é…å»¶æ¥ç¶šã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('ğŸš€ ä½é…å»¶é€šè©±è¦æ±‚ã‚’é€ä¿¡:', broadcastId);
                
                call.on('stream', function(stream) {
                    console.log('ğŸš€ ä½é…å»¶é…ä¿¡ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡');
                    remoteStream = stream;
                    
                    // å—ä¿¡å´ã®æœ€å¤§æ€§èƒ½è¨­å®š
                    try {
                        const pc = call.peerConnection;
                        
                        // å—ä¿¡è€…ã®æœ€å¤§æ€§èƒ½è¨­å®š
                        const receivers = pc.getReceivers();
                        receivers.forEach(receiver => {
                            if (receiver.track && receiver.track.kind === 'video') {
                                console.log('ğŸš€ ä½é…å»¶ãƒ“ãƒ‡ã‚ªå—ä¿¡è€…è¨­å®š');
                                
                                // æœ€å¤§æ€§èƒ½ã®è¨­å®š
                                const transceiver = pc.getTransceivers().find(t => t.receiver === receiver);
                                if (transceiver) {
                                    transceiver.direction = 'recvonly';
                                    console.log('ğŸš€ ä½é…å»¶å—ä¿¡å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰è¨­å®š');
                                }
                            }
                        });
                        
                        // ä½é…å»¶çµ±è¨ˆç›£è¦–
                        const statsInterval = setInterval(() => {
                            if (!isConnected) {
                                clearInterval(statsInterval);
                                return;
                            }
                            
                            pc.getStats().then(stats => {
                                stats.forEach(report => {
                                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                                        console.log('ğŸš€ ä½é…å»¶çµ±è¨ˆ:', {
                                            bitrate: Math.round(report.bytesReceived * 8 / 1000),
                                            fps: report.framesPerSecond,
                                            packetsLost: report.packetsLost,
                                            jitter: report.jitter
                                        });
                                    }
                                });
                            }).catch(e => console.warn('âš ï¸ çµ±è¨ˆå–å¾—å¤±æ•—:', e));
                        }, 2000); // 2ç§’ã”ã¨ã«çµ±è¨ˆè¡¨ç¤º
                        
                    } catch (error) {
                        console.warn('âš ï¸ ä½é…å»¶è¨­å®šã®ä¸€éƒ¨ãŒå¤±æ•—:', error);
                    }
                    
                    // å¼·åˆ¶çš„ã«ã‚¼ãƒ­é…å»¶ãƒ¢ãƒ¼ãƒ‰ã§å‡¦ç†
                    handleRemoteStream(stream);
                    
                    document.getElementById('statusText').textContent = 'ğŸš€ ä½é…å»¶é…ä¿¡ã‚’å—ä¿¡ä¸­...';
                    document.getElementById('connectionStatus').textContent = 'æ¥ç¶šæ¸ˆã¿ (ä½é…å»¶)';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    isConnected = true;
                    console.log('ğŸš€ ä½é…å»¶æ˜ åƒé…ä¿¡é–‹å§‹');
                });
                
                call.on('close', function() {
                    console.log('ğŸ“´ ä½é…å»¶é…ä¿¡çµ‚äº†');
                    disconnectFromBroadcast();
                });
                
                call.on('error', function(error) {
                    console.error('âŒ ä½é…å»¶é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('statusText').textContent = 'ä½é…å»¶é€šè©±ã‚¨ãƒ©ãƒ¼: ' + error.message;
                });
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’ç›£è¦–
                setTimeout(() => {
                    if (!isConnected) {
                        console.warn('âš ï¸ ä½é…å»¶æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ');
                        document.getElementById('statusText').textContent = 'ä½é…å»¶æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - é…ä¿¡å´ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
                    }
                }, 10000); // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                
            } catch (error) {
                console.error('âŒ ä½é…å»¶ãƒ†ã‚¹ãƒˆã«å¤±æ•—:', error);
                let errorMessage = 'ä½é…å»¶ãƒ†ã‚¹ãƒˆã«å¤±æ•—: ';
                
                if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                    errorMessage += 'é…ä¿¡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (error.message.includes('ç¢ºèªå¤±æ•—')) {
                    errorMessage += 'é…ä¿¡ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                } else {
                    errorMessage += error.message;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
            }
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            disconnectFromBroadcast();
            if (peer) {
                peer.destroy();
            }
            window.location.href = 'index.html';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePeer();
            
            // Canvasè¦ç´ ã‚’æº–å‚™
            canvas = document.getElementById('delayCanvas');
            ctx = canvas.getContext('2d');
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('connectBtn').addEventListener('click', connectToBroadcast);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectFromBroadcast);
            document.getElementById('lowLatencyBtn').addEventListener('click', testLowLatency);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('delaySlider').addEventListener('input', updateDelayTime);
            
            // åˆæœŸé…å»¶å€¤ã‚’è¨­å®š
            updateDelayTime();
            
            // å®šæœŸçš„ã«çµ±è¨ˆã‚’æ›´æ–°
            setInterval(updateReceiveStats, 1000);
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ã‚’è¡¨ç¤º
            const supportStatus = typeof MediaStreamTrackProcessor !== 'undefined' 
                ? 'ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿ (é«˜æ€§èƒ½)' 
                : 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ãƒ¢ãƒ¼ãƒ‰';
            console.log('MediaStreamTrackProcessor:', supportStatus);
            document.getElementById('statusText').textContent = 'MediaStreamTrackProcessor: ' + supportStatus;
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            disconnectFromBroadcast();
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html> 