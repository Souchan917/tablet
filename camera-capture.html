<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©æ’®å½± - è¬è§£ãã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-btn {
            background-color: #9AFF9A;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .back-btn:hover {
            background-color: #7FFF7F;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #9AFF9A;
        }

        .camera-section {
            background-color: #222;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .video-container {
            position: relative;
            margin-bottom: 20px;
        }

        #localVideo {
            width: 100%;
            max-width: 640px;
            height: 360px;
            background-color: #000;
            border: 2px solid #444;
            border-radius: 8px;
            object-fit: cover;
        }

        .status-text {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            color: #9AFF9A;
        }

        .camera-controls {
            text-align: center;
            margin: 20px 0;
        }

        .camera-select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #9AFF9A;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
            font-size: 16px;
        }

        .camera-btn {
            background-color: #9AFF9A;
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .camera-btn:hover {
            background-color: #7FFF7F;
        }

        .camera-btn:disabled {
            background-color: #666;
            color: #999;
            cursor: not-allowed;
        }

        .camera-btn.danger {
            background-color: #ff6b6b;
            color: #fff;
        }

        .camera-btn.danger:hover {
            background-color: #ff5252;
        }

        /* ä½é…å»¶ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .low-latency-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: #fff;
            font-weight: bold;
        }

        .low-latency-btn:hover {
            background: linear-gradient(45deg, #FF5252, #FF7979);
        }

        .broadcast-info {
            background-color: #333;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .broadcast-info h3 {
            margin-bottom: 15px;
            color: #9AFF9A;
        }

        .broadcast-id {
            font-family: monospace;
            font-size: 16px;
            padding: 10px;
            background-color: #111;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }

        .connection-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .connection-status.connected {
            background-color: #2d5a2d;
            color: #9AFF9A;
        }

        .connection-status.disconnected {
            background-color: #5a2d2d;
            color: #ff6b6b;
        }

        .connection-status.waiting {
            background-color: #5a5a2d;
            color: #ffff9a;
        }

        /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #666;
            border-top: 2px solid #9AFF9A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #ff6b6b;
            background-color: #2d1a1a;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .streaming-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff6b6b;
            color: #fff;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
    
    <div class="container">
        <h1>ã‚«ãƒ¡ãƒ©æ’®å½±</h1>
        
        <div class="camera-section">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <div id="streamingIndicator" class="streaming-indicator" style="display: none;">
                    ğŸ”´ é…ä¿¡ä¸­
                </div>
            </div>
            
            <div class="status-text" id="statusText">
                <span class="loading"></span> ã‚«ãƒ¡ãƒ©ã‚’æº–å‚™ä¸­...
            </div>
            
            <div class="camera-controls">
                <select id="cameraSelect" class="camera-select">
                    <option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                
                <div>
                    <button class="camera-btn" id="refreshBtn">ã‚«ãƒ¡ãƒ©æ›´æ–°</button>
                    <button class="camera-btn" id="startBtn" disabled>æ’®å½±é–‹å§‹</button>
                    <button class="camera-btn danger" id="stopBtn" disabled>æ’®å½±åœæ­¢</button>
                </div>
                
                <div>
                    <button class="camera-btn low-latency-btn" id="lowLatencyBtn" disabled>ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰</button>
                    <button class="camera-btn" id="fullscreenBtn">å…¨ç”»é¢è¡¨ç¤º</button>
                </div>
            </div>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>
        
        <div class="broadcast-info">
            <h3>é…ä¿¡æƒ…å ±</h3>
            <div class="connection-status disconnected" id="connectionStatus">
                é…ä¿¡æº–å‚™ä¸­...
            </div>
            
            <div>
                <strong>é…ä¿¡ID:</strong>
                <div class="broadcast-id" id="broadcastId">æº–å‚™ä¸­...</div>
                <button class="camera-btn" id="copyIdBtn" disabled>IDã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            
            <div style="margin-top: 15px;">
                <strong>æ¥ç¶šç«¯æœ«æ•°:</strong> <span id="connectionCount">0</span>å°
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let localStream = null;
        let peer = null;
        let connections = [];
        let isStreaming = false;
        let isLowLatencyMode = false;

        // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
        async function getCameraDevices() {
            try {
                updateStatus('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—ä¸­...');
                
                // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å–å¾—
                const tempStream = await navigator.mediaDevices.getUserMedia({video: true});
                tempStream.getTracks().forEach(track => track.stop());
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `ã‚«ãƒ¡ãƒ© ${index + 1}`;
                    select.appendChild(option);
                });
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¡ãƒ©ã‚’é¸æŠ
                if (cameras.length > 0) {
                    select.value = cameras[0].deviceId;
                    enableStartButton();
                }
                
                updateStatus('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—å®Œäº†');
                return cameras;
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—:', error);
                showError('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦ã§ã™');
                return [];
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹
        async function startCamera() {
            try {
                const select = document.getElementById('cameraSelect');
                const deviceId = select.value;
                
                if (!deviceId) {
                    showError('ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                updateStatus('ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ä¸­...');
                clearError();

                // ã‚«ãƒ¡ãƒ©è¨­å®š
                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 60 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };

                // ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®æœ€é©åŒ–
                if (isLowLatencyMode) {
                    constraints.video.frameRate = { ideal: 60, max: 60 };
                    constraints.video.latency = { ideal: 0.01 };
                    constraints.audio.latency = { ideal: 0.01 };
                }

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('localVideo');
                video.srcObject = localStream;
                
                // ä½é…å»¶æœ€é©åŒ–
                if (isLowLatencyMode) {
                    video.style.transform = 'translateZ(0)';
                    video.style.willChange = 'transform';
                    video.style.backfaceVisibility = 'hidden';
                }
                
                updateStatus('ã‚«ãƒ¡ãƒ©é–‹å§‹å®Œäº† - å—ä¿¡ç«¯æœ«ã®æ¥ç¶šã‚’å¾…æ©Ÿä¸­...');
                updateConnectionStatus('waiting');
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('streamingIndicator').style.display = 'block';
                
                isStreaming = true;
                
                // æ—¢å­˜ã®æ¥ç¶šã«é…ä¿¡é–‹å§‹
                connections.forEach(conn => {
                    if (conn.open) {
                        optimizeConnection(conn);
                    }
                });
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã«å¤±æ•—:', error);
                showError('ã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã«å¤±æ•—: ' + error.message);
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            const video = document.getElementById('localVideo');
            video.srcObject = null;
            
            updateStatus('ã‚«ãƒ¡ãƒ©åœæ­¢');
            updateConnectionStatus('disconnected');
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('streamingIndicator').style.display = 'none';
            
            isStreaming = false;
            
            // æ¥ç¶šä¸­ã®é€šè©±ã‚’çµ‚äº†
            connections.forEach(conn => {
                if (conn.close) {
                    conn.close();
                }
            });
            connections = [];
            updateConnectionCount();
        }

        // PeerJSæ¥ç¶šã‚’åˆæœŸåŒ–
        function initializePeer() {
            const peerId = 'tablet-broadcast-' + Date.now().toString(36);
            
            console.log('PeerJSåˆæœŸåŒ–é–‹å§‹:', peerId);
            
            // WebRTCè¨­å®š
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' }
                ],
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-compat',
                rtcpMuxPolicy: 'require',
                iceCandidatePoolSize: 10,
                sdpSemantics: 'unified-plan'
            };

            // ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®æœ€é©åŒ–
            if (isLowLatencyMode) {
                config.iceCandidatePoolSize = 20;
                config.continualGatheringPolicy = 'gather_continually';
            }

            peer = new Peer(peerId, {
                debug: 1,
                config: config
            });

            peer.on('open', function(id) {
                console.log('PeerJSæ¥ç¶šæˆåŠŸ:', id);
                document.getElementById('broadcastId').textContent = id;
                document.getElementById('copyIdBtn').disabled = false;
                
                updateStatus('é…ä¿¡æº–å‚™å®Œäº† - é…ä¿¡IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„');
                updateConnectionStatus('waiting');
            });

            peer.on('call', function(call) {
                console.log('é€šè©±è¦æ±‚ã‚’å—ä¿¡:', call.peer);
                
                if (localStream) {
                    console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å¿œç­”ä¸­...');
                    call.answer(localStream);
                    connections.push(call);
                    
                    call.on('stream', function(remoteStream) {
                        console.log('å—ä¿¡å´ã‹ã‚‰ã®å¿œç­”ã‚¹ãƒˆãƒªãƒ¼ãƒ ');
                    });
                    
                    call.on('close', function() {
                        console.log('é€šè©±çµ‚äº†:', call.peer);
                        connections = connections.filter(conn => conn !== call);
                        updateConnectionCount();
                    });
                    
                    call.on('error', function(error) {
                        console.error('é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                        connections = connections.filter(conn => conn !== call);
                        updateConnectionCount();
                    });
                    
                    // æ¥ç¶šæœ€é©åŒ–
                    optimizeConnection(call);
                    updateConnectionCount();
                    
                    console.log('æ–°ã—ã„è¦–è´è€…ãŒæ¥ç¶šã—ã¾ã—ãŸ:', call.peer);
                } else {
                    console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    call.close();
                }
            });

            peer.on('connection', function(conn) {
                console.log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚’å—ä¿¡:', conn.peer);
                conn.on('open', function() {
                    console.log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šé–‹å§‹');
                    conn.send({ type: 'ping', message: 'é…ä¿¡æº–å‚™å®Œäº†' });
                });
                
                conn.on('data', function(data) {
                    console.log('ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', data);
                });
                
                conn.on('close', function() {
                    console.log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šçµ‚äº†');
                });
            });

            peer.on('error', function(err) {
                console.error('PeerJS ã‚¨ãƒ©ãƒ¼:', err);
                showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + err.type);
                
                // æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å†æ¥ç¶šã‚’è©¦è¡Œ
                if (err.type === 'network' || err.type === 'server-error') {
                    console.log('5ç§’å¾Œã«è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
                    setTimeout(() => {
                        initializePeer();
                    }, 5000);
                }
            });
        }

        // æ¥ç¶šæœ€é©åŒ–
        async function optimizeConnection(call) {
            if (!call.peerConnection) return;
            
            try {
                const pc = call.peerConnection;
                
                // é€ä¿¡è€…è¨­å®šã®æœ€é©åŒ–
                const senders = pc.getSenders();
                for (const sender of senders) {
                    if (sender.track && sender.track.kind === 'video') {
                        const params = sender.getParameters();
                        
                        if (params.encodings && params.encodings.length > 0) {
                            params.encodings.forEach(encoding => {
                                if (isLowLatencyMode) {
                                    // ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
                                    encoding.maxBitrate = 3000000; // 3Mbps
                                    encoding.maxFramerate = 60;
                                    encoding.priority = 'high';
                                } else {
                                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
                                    encoding.maxBitrate = 2000000; // 2Mbps
                                    encoding.maxFramerate = 30;
                                    encoding.priority = 'medium';
                                }
                                encoding.scaleResolutionDownBy = 1;
                            });
                            
                            await sender.setParameters(params);
                            console.log('ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šå®Œäº†');
                        }
                    }
                    
                    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®è¨­å®š
                    if (sender.track && sender.track.kind === 'audio') {
                        const params = sender.getParameters();
                        if (params.encodings && params.encodings.length > 0) {
                            params.encodings.forEach(encoding => {
                                encoding.priority = 'high';
                                encoding.maxBitrate = 128000; // 128kbps
                            });
                            await sender.setParameters(params);
                        }
                    }
                }
                
                console.log('æ¥ç¶šæœ€é©åŒ–å®Œäº†');
                
            } catch (error) {
                console.warn('æ¥ç¶šæœ€é©åŒ–ã®ä¸€éƒ¨ãŒå¤±æ•—:', error);
            }
        }

        // é…ä¿¡IDã‚’ã‚³ãƒ”ãƒ¼
        function copyBroadcastId() {
            const broadcastId = document.getElementById('broadcastId').textContent;
            if (broadcastId && broadcastId !== 'æº–å‚™ä¸­...') {
                navigator.clipboard.writeText(broadcastId).then(() => {
                    const btn = document.getElementById('copyIdBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                    alert('é…ä¿¡ID: ' + broadcastId);
                });
            }
        }

        // ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleLowLatencyMode() {
            isLowLatencyMode = !isLowLatencyMode;
            
            const btn = document.getElementById('lowLatencyBtn');
            if (isLowLatencyMode) {
                btn.textContent = 'ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰: ON';
                btn.style.backgroundColor = '#FF6B6B';
                updateStatus('ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
            } else {
                btn.textContent = 'ğŸš€ ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰: OFF';
                btn.style.backgroundColor = '';
                updateStatus('ä½é…å»¶ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
            }
            
            // é…ä¿¡ä¸­ã®å ´åˆã¯è¨­å®šã‚’å†é©ç”¨
            if (isStreaming) {
                connections.forEach(conn => {
                    optimizeConnection(conn);
                });
            }
        }

        // å…¨ç”»é¢è¡¨ç¤º
        function toggleFullscreen() {
            const video = document.getElementById('localVideo');
            
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.error('ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«å¤±æ•—:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // æ¥ç¶šæ•°ã‚’æ›´æ–°
        function updateConnectionCount() {
            const activeConnections = connections.filter(conn => conn.open).length;
            document.getElementById('connectionCount').textContent = activeConnections;
            
            if (activeConnections > 0) {
                updateConnectionStatus('connected');
            } else if (isStreaming) {
                updateConnectionStatus('waiting');
            } else {
                updateConnectionStatus('disconnected');
            }
        }

        // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'connection-status ' + status;
            
            switch (status) {
                case 'connected':
                    statusElement.textContent = 'é…ä¿¡ä¸­ - è¦–è´è€…ã«æ¥ç¶šæ¸ˆã¿';
                    break;
                case 'waiting':
                    statusElement.textContent = 'é…ä¿¡æº–å‚™å®Œäº† - è¦–è´è€…ã®æ¥ç¶šå¾…æ©Ÿä¸­';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'é…ä¿¡åœæ­¢ä¸­';
                    break;
                default:
                    statusElement.textContent = 'é…ä¿¡æº–å‚™ä¸­...';
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message) {
            const statusElement = document.getElementById('statusText');
            statusElement.innerHTML = message;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            updateStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }

        // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
        function clearError() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.style.display = 'none';
        }

        // é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        function enableStartButton() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('lowLatencyBtn').disabled = false;
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            stopCamera();
            if (peer) {
                peer.destroy();
            }
            window.location.href = 'index.html';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            getCameraDevices();
            initializePeer();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('refreshBtn').addEventListener('click', getCameraDevices);
            document.getElementById('startBtn').addEventListener('click', startCamera);
            document.getElementById('stopBtn').addEventListener('click', stopCamera);
            document.getElementById('lowLatencyBtn').addEventListener('click', toggleLowLatencyMode);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('copyIdBtn').addEventListener('click', copyBroadcastId);
            
            // ã‚«ãƒ¡ãƒ©é¸æŠæ™‚ã«é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('cameraSelect').addEventListener('change', function() {
                if (this.value) {
                    enableStartButton();
                }
            });
            
            // å®šæœŸçš„ã«æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèª
            setInterval(updateConnectionCount, 2000);
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            stopCamera();
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html> 