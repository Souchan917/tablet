<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カメラ撮影 - 謎解きシステム</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">← 戻る</button>
    
    <div class="container">
        <h1>カメラ撮影</h1>
        
        <div class="camera-container">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <p id="statusText">カメラを準備中...</p>
            </div>
            
            <div class="camera-controls">
                <select id="cameraSelect">
                    <option value="">カメラを選択してください</option>
                </select>
                <button class="camera-btn" id="refreshBtn">更新</button>
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn" id="startBtn">撮影開始</button>
                <button class="camera-btn" id="stopBtn" disabled>撮影停止</button>
                <button class="camera-btn" id="fullscreenBtn">全画面表示</button>
            </div>
            
            <div class="connection-info">
                <h3>接続情報</h3>
                <p>配信ID: <span id="peerId">準備中...</span></p>
                <button class="camera-btn" id="copyIdBtn" disabled>IDをコピー</button>
                <p>接続状態: <span id="connectionStatus">準備中</span></p>
                <p>画質: <span id="qualityStatus">自動調整中</span></p>
            </div>
            
            <div class="stream-stats">
                <h3>配信統計</h3>
                <p>ビットレート: <span id="bitrateStats">--- kbps</span></p>
                <p>フレームレート: <span id="fpsStats">--- fps</span></p>
                <p>解像度: <span id="resolutionStats">---x---</span></p>
            </div>
            
            <div class="troubleshooting">
                <h3>⚠️ トラブルシューティング</h3>
                <ul>
                    <li><strong>カメラアクセス:</strong> ブラウザでカメラのアクセス許可を確認</li>
                    <li><strong>HTTPS必須:</strong> localhost:8443 で実行（HTTPでは動作しません）</li>
                    <li><strong>デバッグ:</strong> 開発者ツールのコンソールでエラーを確認</li>
                    <li><strong>配信ID:</strong> 正しくコピーされていることを確認</li>
                    <li><strong>接続待機:</strong> 配信開始後に受信側を接続してください</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="js/app.js"></script>
    <script>
        let localStream = null;
        let peer = null;
        let connections = [];
        let isStreaming = false;
        let recordingChunks = [];

        // カメラデバイスを取得
        async function getCameraDevices() {
            try {
                // カメラアクセス権限を取得
                const tempStream = await navigator.mediaDevices.getUserMedia({video: true});
                tempStream.getTracks().forEach(track => track.stop());
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '<option value="">カメラを選択してください</option>';
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `カメラ ${index + 1}`;
                    select.appendChild(option);
                });
                
                // デフォルトカメラを選択
                if (cameras.length > 0) {
                    select.value = cameras[0].deviceId;
                }
                
                return cameras;
            } catch (error) {
                console.error('カメラデバイスの取得に失敗:', error);
                document.getElementById('statusText').textContent = 'カメラへのアクセス権限が必要です';
                return [];
            }
        }

        // カメラストリームを開始
        async function startCamera() {
            try {
                const select = document.getElementById('cameraSelect');
                const deviceId = select.value;
                
                if (!deviceId) {
                    alert('カメラを選択してください');
                    return;
                }

                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('localVideo');
                video.srcObject = localStream;
                
                document.getElementById('statusText').textContent = 'カメラ開始 - 受信端末の接続を待機中...';
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                isStreaming = true;
                
                // 配信品質の最適化
                await optimizeStreamQuality();
                
                // 既存の接続があれば配信開始
                connections.forEach(conn => {
                    if (conn.open) {
                        sendStreamToConnection(conn);
                    }
                });
                
            } catch (error) {
                console.error('カメラの開始に失敗:', error);
                document.getElementById('statusText').textContent = 'カメラの開始に失敗: ' + error.message;
            }
        }

        // 配信品質を最適化
        async function optimizeStreamQuality() {
            if (!localStream) return;
            
            const videoTrack = localStream.getVideoTracks()[0];
            if (!videoTrack) return;
            
            // 配信品質を動的に調整
            const settings = videoTrack.getSettings();
            console.log('カメラ設定:', settings);
            
            // 帯域幅に応じてビットレートを調整
            try {
                await videoTrack.applyConstraints({
                    width: { ideal: 1280, max: 1920 },
                    height: { ideal: 720, max: 1080 },
                    frameRate: { ideal: 30, max: 30 }
                });
            } catch (error) {
                console.warn('制約の適用に失敗:', error);
            }
        }

        // 接続に配信を送信
        function sendStreamToConnection(call) {
            if (!localStream) return;
            
            // 配信品質の調整
            const senders = call.peerConnection.getSenders();
            senders.forEach(sender => {
                if (sender.track && sender.track.kind === 'video') {
                    const params = sender.getParameters();
                    if (params.encodings) {
                        params.encodings.forEach(encoding => {
                            encoding.maxBitrate = 2000000; // 2Mbps
                            encoding.maxFramerate = 30;
                        });
                        sender.setParameters(params);
                    }
                }
            });
        }

        // カメラストリームを停止
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            const video = document.getElementById('localVideo');
            video.srcObject = null;
            
            document.getElementById('statusText').textContent = 'カメラ停止';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            isStreaming = false;
            
            // 接続中の通話を終了
            connections.forEach(conn => {
                if (conn.close) {
                    conn.close();
                }
            });
            connections = [];
            updateConnectionStatus();
        }

        // PeerJS接続を初期化
        function initializePeer() {
            // 動的なpeerIDを生成（配信側）
            const peerId = 'camera-broadcast-' + Math.random().toString(36).substr(2, 9);
            
            console.log('PeerJS初期化開始:', peerId);
            
            peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 2, // デバッグレベルを追加
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', function(id) {
                console.log('✅ PeerJS接続成功:', id);
                document.getElementById('peerId').textContent = id;
                document.getElementById('connectionStatus').textContent = '接続可能';
                document.getElementById('copyIdBtn').disabled = false;
                
                // 接続成功をユーザーに通知
                document.getElementById('statusText').textContent = '配信準備完了 - 配信IDをコピーして共有してください';
            });

            peer.on('call', function(call) {
                console.log('🔔 通話要求を受信:', call.peer);
                
                if (localStream) {
                    console.log('📡 ローカルストリームで応答中...');
                    call.answer(localStream);
                    connections.push(call);
                    
                    // 接続後の処理
                    call.on('stream', function(remoteStream) {
                        console.log('📺 受信側からの応答ストリーム');
                    });
                    
                    call.on('close', function() {
                        console.log('📴 通話終了:', call.peer);
                        connections = connections.filter(conn => conn !== call);
                        updateConnectionStatus();
                    });
                    
                    call.on('error', function(error) {
                        console.error('❌ 通話エラー:', error);
                        connections = connections.filter(conn => conn !== call);
                        updateConnectionStatus();
                    });
                    
                    // 配信品質を最適化
                    sendStreamToConnection(call);
                    updateConnectionStatus();
                    
                    console.log('✅ 新しい視聴者が接続しました:', call.peer);
                } else {
                    console.error('❌ ローカルストリームが利用できません');
                    call.close();
                }
            });

            peer.on('connection', function(conn) {
                console.log('データ接続:', conn.peer);
                conn.on('open', function() {
                    console.log('データ接続開始');
                });
            });

            peer.on('error', function(err) {
                console.error('❌ PeerJS エラー:', err);
                document.getElementById('connectionStatus').textContent = 'エラー: ' + err.type;
                
                // エラーの種類に応じて詳細なメッセージを表示
                let errorMessage = 'エラーが発生しました: ';
                switch (err.type) {
                    case 'network':
                        errorMessage += 'ネットワーク接続エラー';
                        break;
                    case 'server-error':
                        errorMessage += 'サーバーエラー';
                        break;
                    case 'unavailable-id':
                        errorMessage += 'IDが使用中です';
                        break;
                    case 'browser-incompatible':
                        errorMessage += 'ブラウザが対応していません';
                        break;
                    default:
                        errorMessage += err.type;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
                
                // 接続エラーの場合は再接続を試行
                if (err.type === 'network' || err.type === 'server-error') {
                    console.log('🔄 5秒後に自動再接続を試行します...');
                    setTimeout(() => {
                        initializePeer();
                    }, 5000);
                }
            });
        }

        // 配信IDをコピー
        function copyBroadcastId() {
            const peerId = document.getElementById('peerId').textContent;
            if (peerId && peerId !== '準備中...') {
                navigator.clipboard.writeText(peerId).then(() => {
                    const btn = document.getElementById('copyIdBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'コピー完了!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('コピーに失敗:', err);
                    alert('配信ID: ' + peerId);
                });
            }
        }

        // 配信統計を更新
        function updateStreamStats() {
            if (!connections.length || !localStream) return;
            
            connections.forEach(conn => {
                if (conn.peerConnection) {
                    conn.peerConnection.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                                const bitrate = Math.round(report.bytesSent * 8 / 1000); // kbps
                                const fps = report.framesPerSecond || 0;
                                
                                document.getElementById('bitrateStats').textContent = bitrate + ' kbps';
                                document.getElementById('fpsStats').textContent = fps + ' fps';
                            }
                        });
                    }).catch(err => {
                        console.warn('統計取得エラー:', err);
                    });
                }
            });
            
            // 解像度情報を更新
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    if (settings.width && settings.height) {
                        document.getElementById('resolutionStats').textContent = 
                            `${settings.width}x${settings.height}`;
                    }
                }
            }
        }

        // 接続状態を更新
        function updateConnectionStatus() {
            const activeConnections = connections.filter(conn => conn.open).length;
            document.getElementById('connectionStatus').textContent = 
                `接続中: ${activeConnections}台`;
                
            // 接続状態をリアルタイムで監視
            connections.forEach(conn => {
                if (conn.peerConnection) {
                    conn.peerConnection.oniceconnectionstatechange = function() {
                        console.log('ICE接続状態:', conn.peerConnection.iceConnectionState);
                        if (conn.peerConnection.iceConnectionState === 'disconnected' || 
                            conn.peerConnection.iceConnectionState === 'failed') {
                            connections = connections.filter(c => c !== conn);
                            updateConnectionStatus();
                        }
                    };
                }
            });
            
            // 統計情報も更新
            updateStreamStats();
        }

        // 全画面表示
        function toggleFullscreen() {
            const video = document.getElementById('localVideo');
            
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.error('フルスクリーン表示に失敗:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // 戻るボタン
        function goBack() {
            stopCamera();
            if (peer) {
                peer.destroy();
            }
            window.location.href = 'index.html';
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            getCameraDevices();
            initializePeer();
            
            // イベントリスナーを追加
            document.getElementById('refreshBtn').addEventListener('click', getCameraDevices);
            document.getElementById('startBtn').addEventListener('click', startCamera);
            document.getElementById('stopBtn').addEventListener('click', stopCamera);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('copyIdBtn').addEventListener('click', copyBroadcastId);
            
            // 定期的に接続状態と統計を確認
            setInterval(updateConnectionStatus, 3000);
            setInterval(updateStreamStats, 1000);
        });

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', function() {
            stopCamera();
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html> 