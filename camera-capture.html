<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©æ’®å½± - è¬è§£ãã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
    
    <div class="container">
        <h1>ã‚«ãƒ¡ãƒ©æ’®å½±</h1>
        
        <div class="camera-container">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <p id="statusText">ã‚«ãƒ¡ãƒ©ã‚’æº–å‚™ä¸­...</p>
            </div>
            
            <div class="camera-controls">
                <select id="cameraSelect">
                    <option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                <button class="camera-btn" id="refreshBtn">æ›´æ–°</button>
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn" id="startBtn">æ’®å½±é–‹å§‹</button>
                <button class="camera-btn" id="stopBtn" disabled>æ’®å½±åœæ­¢</button>
                <button class="camera-btn" id="fullscreenBtn">å…¨ç”»é¢è¡¨ç¤º</button>
            </div>
            
            <div class="connection-info">
                <h3>æ¥ç¶šæƒ…å ±</h3>
                <p>é…ä¿¡ID: <span id="peerId">æº–å‚™ä¸­...</span></p>
                <button class="camera-btn" id="copyIdBtn" disabled>IDã‚’ã‚³ãƒ”ãƒ¼</button>
                <p>æ¥ç¶šçŠ¶æ…‹: <span id="connectionStatus">æº–å‚™ä¸­</span></p>
                <p>ç”»è³ª: <span id="qualityStatus">è‡ªå‹•èª¿æ•´ä¸­</span></p>
            </div>
            
            <div class="stream-stats">
                <h3>é…ä¿¡çµ±è¨ˆ</h3>
                <p>ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ: <span id="bitrateStats">--- kbps</span></p>
                <p>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: <span id="fpsStats">--- fps</span></p>
                <p>è§£åƒåº¦: <span id="resolutionStats">---x---</span></p>
            </div>
            
            <div class="troubleshooting">
                <h3>âš ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
                <ul>
                    <li><strong>ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ç¢ºèª</li>
                    <li><strong>HTTPSå¿…é ˆ:</strong> localhost:8443 ã§å®Ÿè¡Œï¼ˆHTTPã§ã¯å‹•ä½œã—ã¾ã›ã‚“ï¼‰</li>
                    <li><strong>ãƒ‡ãƒãƒƒã‚°:</strong> é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª</li>
                    <li><strong>é…ä¿¡ID:</strong> æ­£ã—ãã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                    <li><strong>æ¥ç¶šå¾…æ©Ÿ:</strong> é…ä¿¡é–‹å§‹å¾Œã«å—ä¿¡å´ã‚’æ¥ç¶šã—ã¦ãã ã•ã„</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="js/app.js"></script>
    <script>
        let localStream = null;
        let peer = null;
        let connections = [];
        let isStreaming = false;
        let recordingChunks = [];

        // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
        async function getCameraDevices() {
            try {
                // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å–å¾—
                const tempStream = await navigator.mediaDevices.getUserMedia({video: true});
                tempStream.getTracks().forEach(track => track.stop());
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `ã‚«ãƒ¡ãƒ© ${index + 1}`;
                    select.appendChild(option);
                });
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¡ãƒ©ã‚’é¸æŠ
                if (cameras.length > 0) {
                    select.value = cameras[0].deviceId;
                }
                
                return cameras;
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—:', error);
                document.getElementById('statusText').textContent = 'ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦ã§ã™';
                return [];
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹å§‹
        async function startCamera() {
            try {
                const select = document.getElementById('cameraSelect');
                const deviceId = select.value;
                
                if (!deviceId) {
                    alert('ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('localVideo');
                video.srcObject = localStream;
                
                document.getElementById('statusText').textContent = 'ã‚«ãƒ¡ãƒ©é–‹å§‹ - å—ä¿¡ç«¯æœ«ã®æ¥ç¶šã‚’å¾…æ©Ÿä¸­...';
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                isStreaming = true;
                
                // é…ä¿¡å“è³ªã®æœ€é©åŒ–
                await optimizeStreamQuality();
                
                // æ—¢å­˜ã®æ¥ç¶šãŒã‚ã‚Œã°é…ä¿¡é–‹å§‹
                connections.forEach(conn => {
                    if (conn.open) {
                        sendStreamToConnection(conn);
                    }
                });
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã«å¤±æ•—:', error);
                document.getElementById('statusText').textContent = 'ã‚«ãƒ¡ãƒ©ã®é–‹å§‹ã«å¤±æ•—: ' + error.message;
            }
        }

        // é…ä¿¡å“è³ªã‚’æœ€é©åŒ–
        async function optimizeStreamQuality() {
            if (!localStream) return;
            
            const videoTrack = localStream.getVideoTracks()[0];
            if (!videoTrack) return;
            
            // é…ä¿¡å“è³ªã‚’å‹•çš„ã«èª¿æ•´
            const settings = videoTrack.getSettings();
            console.log('ã‚«ãƒ¡ãƒ©è¨­å®š:', settings);
            
            // å¸¯åŸŸå¹…ã«å¿œã˜ã¦ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã‚’èª¿æ•´
            try {
                await videoTrack.applyConstraints({
                    width: { ideal: 1280, max: 1920 },
                    height: { ideal: 720, max: 1080 },
                    frameRate: { ideal: 30, max: 30 }
                });
            } catch (error) {
                console.warn('åˆ¶ç´„ã®é©ç”¨ã«å¤±æ•—:', error);
            }
        }

        // æ¥ç¶šã«é…ä¿¡ã‚’é€ä¿¡
        function sendStreamToConnection(call) {
            if (!localStream) return;
            
            // é…ä¿¡å“è³ªã®èª¿æ•´
            const senders = call.peerConnection.getSenders();
            senders.forEach(sender => {
                if (sender.track && sender.track.kind === 'video') {
                    const params = sender.getParameters();
                    if (params.encodings) {
                        params.encodings.forEach(encoding => {
                            encoding.maxBitrate = 2000000; // 2Mbps
                            encoding.maxFramerate = 30;
                        });
                        sender.setParameters(params);
                    }
                }
            });
        }

        // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            const video = document.getElementById('localVideo');
            video.srcObject = null;
            
            document.getElementById('statusText').textContent = 'ã‚«ãƒ¡ãƒ©åœæ­¢';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            isStreaming = false;
            
            // æ¥ç¶šä¸­ã®é€šè©±ã‚’çµ‚äº†
            connections.forEach(conn => {
                if (conn.close) {
                    conn.close();
                }
            });
            connections = [];
            updateConnectionStatus();
        }

        // PeerJSæ¥ç¶šã‚’åˆæœŸåŒ–
        function initializePeer() {
            // å‹•çš„ãªpeerIDã‚’ç”Ÿæˆï¼ˆé…ä¿¡å´ï¼‰
            const peerId = 'camera-broadcast-' + Math.random().toString(36).substr(2, 9);
            
            console.log('PeerJSåˆæœŸåŒ–é–‹å§‹:', peerId);
            
            peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 2, // ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ 
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', function(id) {
                console.log('âœ… PeerJSæ¥ç¶šæˆåŠŸ:', id);
                document.getElementById('peerId').textContent = id;
                document.getElementById('connectionStatus').textContent = 'æ¥ç¶šå¯èƒ½';
                document.getElementById('copyIdBtn').disabled = false;
                
                // æ¥ç¶šæˆåŠŸã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
                document.getElementById('statusText').textContent = 'é…ä¿¡æº–å‚™å®Œäº† - é…ä¿¡IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„';
            });

            peer.on('call', function(call) {
                console.log('ğŸ”” é€šè©±è¦æ±‚ã‚’å—ä¿¡:', call.peer);
                
                if (localStream) {
                    console.log('ğŸ“¡ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å¿œç­”ä¸­...');
                    call.answer(localStream);
                    connections.push(call);
                    
                    // æ¥ç¶šå¾Œã®å‡¦ç†
                    call.on('stream', function(remoteStream) {
                        console.log('ğŸ“º å—ä¿¡å´ã‹ã‚‰ã®å¿œç­”ã‚¹ãƒˆãƒªãƒ¼ãƒ ');
                    });
                    
                    call.on('close', function() {
                        console.log('ğŸ“´ é€šè©±çµ‚äº†:', call.peer);
                        connections = connections.filter(conn => conn !== call);
                        updateConnectionStatus();
                    });
                    
                    call.on('error', function(error) {
                        console.error('âŒ é€šè©±ã‚¨ãƒ©ãƒ¼:', error);
                        connections = connections.filter(conn => conn !== call);
                        updateConnectionStatus();
                    });
                    
                    // é…ä¿¡å“è³ªã‚’æœ€é©åŒ–
                    sendStreamToConnection(call);
                    updateConnectionStatus();
                    
                    console.log('âœ… æ–°ã—ã„è¦–è´è€…ãŒæ¥ç¶šã—ã¾ã—ãŸ:', call.peer);
                } else {
                    console.error('âŒ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    call.close();
                }
            });

            peer.on('connection', function(conn) {
                console.log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶š:', conn.peer);
                conn.on('open', function() {
                    console.log('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šé–‹å§‹');
                });
            });

            peer.on('error', function(err) {
                console.error('âŒ PeerJS ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('connectionStatus').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.type;
                
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ã¦è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ';
                switch (err.type) {
                    case 'network':
                        errorMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'server-error':
                        errorMessage += 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼';
                        break;
                    case 'unavailable-id':
                        errorMessage += 'IDãŒä½¿ç”¨ä¸­ã§ã™';
                        break;
                    case 'browser-incompatible':
                        errorMessage += 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
                        break;
                    default:
                        errorMessage += err.type;
                }
                
                document.getElementById('statusText').textContent = errorMessage;
                
                // æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å†æ¥ç¶šã‚’è©¦è¡Œ
                if (err.type === 'network' || err.type === 'server-error') {
                    console.log('ğŸ”„ 5ç§’å¾Œã«è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œã—ã¾ã™...');
                    setTimeout(() => {
                        initializePeer();
                    }, 5000);
                }
            });
        }

        // é…ä¿¡IDã‚’ã‚³ãƒ”ãƒ¼
        function copyBroadcastId() {
            const peerId = document.getElementById('peerId').textContent;
            if (peerId && peerId !== 'æº–å‚™ä¸­...') {
                navigator.clipboard.writeText(peerId).then(() => {
                    const btn = document.getElementById('copyIdBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                    alert('é…ä¿¡ID: ' + peerId);
                });
            }
        }

        // é…ä¿¡çµ±è¨ˆã‚’æ›´æ–°
        function updateStreamStats() {
            if (!connections.length || !localStream) return;
            
            connections.forEach(conn => {
                if (conn.peerConnection) {
                    conn.peerConnection.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'outbound-rtp' && report.mediaType === 'video') {
                                const bitrate = Math.round(report.bytesSent * 8 / 1000); // kbps
                                const fps = report.framesPerSecond || 0;
                                
                                document.getElementById('bitrateStats').textContent = bitrate + ' kbps';
                                document.getElementById('fpsStats').textContent = fps + ' fps';
                            }
                        });
                    }).catch(err => {
                        console.warn('çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                    });
                }
            });
            
            // è§£åƒåº¦æƒ…å ±ã‚’æ›´æ–°
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    if (settings.width && settings.height) {
                        document.getElementById('resolutionStats').textContent = 
                            `${settings.width}x${settings.height}`;
                    }
                }
            }
        }

        // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
        function updateConnectionStatus() {
            const activeConnections = connections.filter(conn => conn.open).length;
            document.getElementById('connectionStatus').textContent = 
                `æ¥ç¶šä¸­: ${activeConnections}å°`;
                
            // æ¥ç¶šçŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
            connections.forEach(conn => {
                if (conn.peerConnection) {
                    conn.peerConnection.oniceconnectionstatechange = function() {
                        console.log('ICEæ¥ç¶šçŠ¶æ…‹:', conn.peerConnection.iceConnectionState);
                        if (conn.peerConnection.iceConnectionState === 'disconnected' || 
                            conn.peerConnection.iceConnectionState === 'failed') {
                            connections = connections.filter(c => c !== conn);
                            updateConnectionStatus();
                        }
                    };
                }
            });
            
            // çµ±è¨ˆæƒ…å ±ã‚‚æ›´æ–°
            updateStreamStats();
        }

        // å…¨ç”»é¢è¡¨ç¤º
        function toggleFullscreen() {
            const video = document.getElementById('localVideo');
            
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.error('ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã«å¤±æ•—:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            stopCamera();
            if (peer) {
                peer.destroy();
            }
            window.location.href = 'index.html';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            getCameraDevices();
            initializePeer();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.getElementById('refreshBtn').addEventListener('click', getCameraDevices);
            document.getElementById('startBtn').addEventListener('click', startCamera);
            document.getElementById('stopBtn').addEventListener('click', stopCamera);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('copyIdBtn').addEventListener('click', copyBroadcastId);
            
            // å®šæœŸçš„ã«æ¥ç¶šçŠ¶æ…‹ã¨çµ±è¨ˆã‚’ç¢ºèª
            setInterval(updateConnectionStatus, 3000);
            setInterval(updateStreamStats, 1000);
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            stopCamera();
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html> 