# 謎解きシステム

このプロジェクトは、11チームの進捗管理と車両番号表示、カメラ配信機能を持つ謎解き用システムです。

## 機能一覧

### 1. 入口ページ (`index.html`)
- 各機能へのナビゲーション
- 黒背景に黄緑色のボタン7個

### 2. STAFF制御 (`staff.html`)
- 11チームの進捗バー表示
- 個別チームの「Next」「Back」ボタン
- 全チーム一括操作

### 3. MASTER制御 (`master.html`)
- STAFF機能に加えて
- 車両番号の手動加減機能

### 4. モニター前 (`monitor-front.html`)
- チーム進捗に応じた画像の全画面表示
- 自動/手動チーム選択
- 前面用画像セット使用

### 5. モニター後 (`monitor-back.html`)
- モニター前と同様の機能
- 後面用画像セット使用

### 6. 車両番号表示 (`car-number.html`)
- 車両番号の大きな表示
- 1秒ごとの自動減少機能
- 手動設定機能

### 7. カメラ撮影 (`camera-capture.html`)
- **高品質WebRTC配信**: 最大1080p 30fps対応
- **自動品質調整**: 帯域幅に応じて自動的にビットレートを調整（最大2Mbps）
- **複数カメラ対応**: 複数のカメラデバイスから選択可能
- **配信ID管理**: 自動生成された配信IDでワンクリックコピー
- **リアルタイム統計**: ビットレート、フレームレート、解像度を監視
- **接続状態監視**: 接続中の受信端末数をリアルタイム表示
- **エラー処理**: 自動再接続機能で安定した配信を実現

### 8. カメラ映像 (`camera-view.html`)
- **高性能遅延バッファ**: MediaStreamTrackProcessorを使用した低遅延処理
- **フレーム単位制御**: 個別フレームをバッファリングして正確な遅延を実現
- **フォールバック機能**: 古いブラウザでも動作する従来方式を自動選択
- **可変遅延設定**: 0〜10秒の範囲で1秒単位で調整可能
- **受信統計監視**: 受信ビットレート、フレームレート、パケットロスを表示
- **バッファ状態表示**: フレームキューの状態をリアルタイム監視
- **配信ID入力**: 手動入力またはクリップボード貼り付けで接続
- **全画面表示**: 映像の全画面表示機能

## セットアップ手順

### 1. 必要なファイル構成
```
tablet/
├── index.html
├── staff.html
├── master.html
├── monitor-front.html
├── monitor-back.html
├── car-number.html
├── camera-capture.html
├── camera-view.html
├── styles.css
├── js/
│   ├── firebase-config.js
│   └── app.js
└── images/
    ├── front/
    │   ├── progress_0.jpg
    │   ├── progress_1.jpg
    │   ├── ...
    │   └── progress_10.jpg
    └── back/
        ├── progress_0.jpg
        ├── progress_1.jpg
        ├── ...
        └── progress_10.jpg
```

### 2. 画像ファイルの準備
- `images/front/` フォルダに `progress_0.jpg` から `progress_10.jpg` まで11枚の画像を配置
- `images/back/` フォルダに同様に11枚の画像を配置
- 各画像は進捗レベルに応じて表示されます

### 3. Firebase設定
- `js/firebase-config.js` にFirebaseプロジェクトの設定が含まれています
- 必要に応じて設定を変更してください

### 4. Firestoreデータベース構造
```
- teams/
  - 1/
    - progress: 0
    - lastUpdated: timestamp
  - 2/
    - progress: 0
    - lastUpdated: timestamp
  - ...
  - 11/
    - progress: 0
    - lastUpdated: timestamp
- global/
  - carNumber/
    - value: 3600
    - lastUpdated: timestamp
```

## 使用方法

### 基本的な流れ
1. `index.html` を開いて各機能にアクセス
2. STAFF/MASTERページで進捗を管理
3. モニターページで参加者に進捗を表示
4. 車両番号ページで時間経過を演出
5. カメラ機能で映像配信

### カメラシステムの使用方法
1. **配信側の設定**:
   - `camera-capture.html` を開く
   - カメラデバイスを選択
   - 「カメラ開始」ボタンをクリック
   - 表示された配信IDをコピー

2. **受信側の設定**:
   - `camera-view.html` を開く
   - 配信IDを入力（貼り付けボタンでクリップボードから自動入力）
   - 「接続開始」ボタンをクリック
   - 遅延時間をスライダーで調整（0〜10秒）

3. **⚡ 超低遅延モード**:
   - 遅延スライダーを「0秒」に設定
   - 「⚡ 超低遅延モード」ボタンをクリック
   - 同じWi-Fiネットワークなら10ms以下の遅延を実現
   - リアルタイムでの映像配信が可能

4. **監視と調整**:
   - 配信側で接続状態とビットレートを確認
   - 受信側でパケットロスとバッファ状態を監視
   - 必要に応じて遅延時間を調整

5. **高度な機能**:
   - 全画面表示でプレゼンテーション
   - 複数の受信端末での同時視聴
   - 配信品質の自動調整

### 💰 コスト情報
- **完全無料**: WebRTC + PeerJS技術により費用は一切かかりません
- **データ通信量**: インターネット回線のデータ通信量を消費します
  - 低画質（480p）: 約15-30MB/分
  - 標準画質（720p）: 約30-60MB/分
  - 高画質（1080p）: 約60-120MB/分
- **Wi-Fi環境**: 通常は無制限のため問題ありません
- **モバイル回線**: データ通信量に注意が必要です

### 注意事項
- インターネット接続が必要です（Firebase、PeerJS使用）
- **カメラ機能は HTTPS 環境で使用してください**
- 複数デバイスでの同時使用を前提として設計されています

### HTTPS サーバーの起動
カメラ機能を使用するには、HTTPSサーバーを起動する必要があります：

```bash
# Node.js が必要です (バージョン 14.0.0 以降)
npm start

# または直接実行
node start-https-server.js
```

サーバー起動後、以下のURLにアクセスしてください：
- **配信側**: `https://localhost:8443/camera-capture.html`
- **受信側**: `https://localhost:8443/camera-view.html`

⚠️ **重要**: 
- 初回アクセス時にブラウザで「詳細設定」→「localhost にアクセスする (安全ではありません)」をクリックして証明書を信頼してください
- HTTPではカメラアクセスができません。必ずHTTPS環境で実行してください

### トラブルシューティング

#### カメラ接続の問題
1. **配信側で接続中が0台のまま**:
   - 配信IDが正しくコピーされているか確認
   - 受信側で「接続開始」ボタンを押しているか確認
   - 開発者ツールのコンソールでエラーを確認

2. **受信側で接続タイムアウト**:
   - 配信側が先に開始されているか確認
   - 配信IDが正確に入力されているか確認
   - PeerJSサーバーへの接続を確認

3. **カメラアクセスエラー**:
   - ブラウザでカメラへのアクセス許可を確認
   - 他のアプリケーションがカメラを使用していないか確認
   - HTTPSサーバーが正しく起動しているか確認

#### 一般的なエラー
- **Firebase接続エラー**: ブラウザの開発者ツールでコンソールを確認
- **画像表示エラー**: 画像ファイルのパスと名前を確認
- **PeerJS接続エラー**: インターネット接続とファイアウォール設定を確認

#### デバッグ手順
1. ブラウザの開発者ツール（F12）を開く
2. コンソールタブでエラーメッセージを確認
3. 配信側と受信側の両方でログを確認
4. ネットワークタブでPeerJS接続を確認

## 技術仕様
- **Firebase Firestore**: リアルタイムデータベース（チーム進捗、車両番号）
- **WebRTC + PeerJS**: P2P映像配信（最大1080p 30fps）
- **MediaStreamTrackProcessor**: 高性能フレーム処理（Chrome/Edge/Safari対応）
- **HTML5 Canvas**: 遅延バッファリング（フォールバック機能）
- **Vanilla JavaScript**: フレームワーク不使用による軽量設計

### ブラウザ対応
- **Chrome/Edge**: 完全対応（MediaStreamTrackProcessor使用）
- **Safari**: 部分対応（フォールバック機能）
- **Firefox**: 基本機能対応
- **HTTPS必須**: カメラアクセスにはSSL証明書が必要

## ライセンス
このプロジェクトはMITライセンスで公開されています。 